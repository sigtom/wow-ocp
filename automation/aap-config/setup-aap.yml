---
- name: Configure Ansible Automation Platform (Config as Code)
  hosts: localhost
  connection: local
  gather_facts: false
  collections:
    - infra.controller_configuration

  vars:
    controller_host: "http://aap-controller-service.ansible-automation-platform.svc.cluster.local"
    # Authenticate using the admin password injected via env var
    controller_username: "admin"
    controller_password: "{{ lookup('env', 'CONTROLLER_PASSWORD') }}"
    
    # Configuration Data
    aap_organization: "Default"
    
    # Secrets injected from K8s Secret
    proxmox_url: "https://172.16.110.101:8006"
    proxmox_user: "{{ lookup('env', 'PROXMOX_USER') | default('sre-bot@pve') }}"
    proxmox_token_id: "{{ lookup('env', 'PROXMOX_TOKEN_ID') | default('sre-token') }}"
    proxmox_token_secret: "{{ lookup('env', 'PROXMOX_TOKEN_SECRET') }}"
    
    cloudflare_token: "{{ lookup('env', 'CLOUDFLARE_TOKEN') }}"
    
    ssh_private_key: "{{ lookup('env', 'SSH_PRIVATE_KEY') }}"
    
    # DUMB Debrid secrets (injected from dumb-secrets K8s Secret)
    realdebrid_api_key: "{{ lookup('env', 'REALDEBRID_API_KEY') }}"
    torbox_api_key: "{{ lookup('env', 'TORBOX_API_KEY') }}"
    riven_api_key: "{{ lookup('env', 'RIVEN_API_KEY') }}"
    plex_token: "{{ lookup('env', 'PLEX_TOKEN') }}"
    overseerr_api_key: "{{ lookup('env', 'OVERSEERR_API_KEY') }}"
    dumb_postgres_password: "{{ lookup('env', 'DUMB_POSTGRES_PASSWORD') }}"
    dumb_pgadmin_password: "{{ lookup('env', 'DUMB_PGADMIN_PASSWORD') }}"
    
    # Arr API keys (injected from media-arr-secrets K8s Secret)
    sonarr_api_key: "{{ lookup('env', 'SONARR_API_KEY') }}"
    radarr_api_key: "{{ lookup('env', 'RADARR_API_KEY') }}"
    prowlarr_api_key: "{{ lookup('env', 'PROWLARR_API_KEY') }}"
    
    # Image we just built
    ee_image: "image-registry.openshift-image-registry.svc:5000/ansible-automation-platform/custom-homelab-ee:latest"

  tasks:
    - name: Wait for AAP to be ready
      uri:
        url: "{{ controller_host }}/api/v2/ping/"
        method: GET
        user: "{{ controller_username }}"
        password: "{{ controller_password }}"
        force_basic_auth: yes
        validate_certs: no
      register: result
      until: result.status == 200
      retries: 60
      delay: 5

    # -------------------------------------------------------
    # 1. Credential Types
    # -------------------------------------------------------
    - name: Create Proxmox Credential Type
      ansible.controller.credential_type:
        name: "Proxmox VE"
        description: "Proxmox API Token authentication"
        kind: cloud
        inputs:
          fields:
            - id: host
              label: Proxmox Host URL
              type: string
            - id: username
              label: API User (user@realm)
              type: string
            - id: token_id
              label: Token ID
              type: string
            - id: token_secret
              label: Token Secret
              type: string
              secret: true
          required:
            - host
            - username
            - token_id
            - token_secret
        injectors:
          env:
            PROXMOX_URL: "{% raw %}{{ host }}{% endraw %}"
            PROXMOX_USER: "{% raw %}{{ username }}{% endraw %}"
            PROXMOX_TOKEN_ID: "{% raw %}{{ token_id }}{% endraw %}"
            PROXMOX_SRE_BOT_API_TOKEN: "{% raw %}{{ token_secret }}{% endraw %}"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create Cloudflare Credential Type
      ansible.controller.credential_type:
        name: "Cloudflare API"
        description: "Cloudflare DNS API Token"
        kind: cloud
        inputs:
          fields:
            - id: api_token
              label: API Token
              type: string
              secret: true
          required:
            - api_token
        injectors:
          env:
            CF_DNS_API_TOKEN: "{% raw %}{{ api_token }}{% endraw %}"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create DUMB Secrets Credential Type
      ansible.controller.credential_type:
        name: "DUMB Debrid Secrets"
        description: "RealDebrid and TorBox API keys for DUMB media stack"
        kind: cloud
        inputs:
          fields:
            - id: realdebrid_api_key
              label: RealDebrid API Key
              type: string
              secret: true
            - id: torbox_api_key
              label: TorBox API Key
              type: string
              secret: true
            - id: riven_api_key
              label: Riven API Key
              type: string
              secret: true
            - id: plex_token
              label: Plex API Token
              type: string
              secret: true
            - id: overseerr_api_key
              label: Overseerr API Key
              type: string
              secret: true
            - id: dumb_postgres_password
              label: DUMB Postgres Password
              type: string
              secret: true
            - id: dumb_pgadmin_password
              label: DUMB pgAdmin Password
              type: string
              secret: true
          required:
            - realdebrid_api_key
            - torbox_api_key
        injectors:
          extra_vars:
            realdebrid_api_key: "{% raw %}{{ realdebrid_api_key }}{% endraw %}"
            torbox_api_key: "{% raw %}{{ torbox_api_key }}{% endraw %}"
            riven_api_key: "{% raw %}{{ riven_api_key }}{% endraw %}"
            plex_token: "{% raw %}{{ plex_token }}{% endraw %}"
            overseerr_api_key: "{% raw %}{{ overseerr_api_key }}{% endraw %}"
            dumb_postgres_password: "{% raw %}{{ dumb_postgres_password }}{% endraw %}"
            dumb_pgadmin_password: "{% raw %}{{ dumb_pgadmin_password }}{% endraw %}"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create Media Arr Secrets Credential Type
      ansible.controller.credential_type:
        name: "Media Arr API Keys"
        description: "API keys for Sonarr, Radarr, and Prowlarr"
        kind: cloud
        inputs:
          fields:
            - id: sonarr_api_key
              label: Sonarr API Key
              type: string
              secret: true
            - id: radarr_api_key
              label: Radarr API Key
              type: string
              secret: true
            - id: prowlarr_api_key
              label: Prowlarr API Key
              type: string
              secret: true
          required:
            - sonarr_api_key
            - radarr_api_key
            - prowlarr_api_key
        injectors:
          extra_vars:
            sonarr_api_key: "{% raw %}{{ sonarr_api_key }}{% endraw %}"
            radarr_api_key: "{% raw %}{{ radarr_api_key }}{% endraw %}"
            prowlarr_api_key: "{% raw %}{{ prowlarr_api_key }}{% endraw %}"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create Pi-hole API Keys Credential Type
      ansible.controller.credential_type:
        name: "Pi-hole API Keys"
        description: "API tokens for all three Pi-hole instances"
        kind: cloud
        inputs:
          fields:
            - id: key_116
              label: API Key (10.0.0.116)
              type: string
              secret: true
            - id: key_100_2
              label: API Key (172.16.100.2)
              type: string
              secret: true
            - id: key_110_100
              label: API Key (172.16.110.100:20720)
              type: string
              secret: true
          required:
            - key_116
            - key_100_2
            - key_110_100
        injectors:
          env:
            PIHOLE_KEY_116: "{% raw %}{{ key_116 }}{% endraw %}"
            PIHOLE_KEY_100_2: "{% raw %}{{ key_100_2 }}{% endraw %}"
            PIHOLE_KEY_110_100: "{% raw %}{{ key_110_100 }}{% endraw %}"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    # -------------------------------------------------------
    # 2. Execution Environments
    # -------------------------------------------------------
    - name: Create Custom HomeLab EE
      ansible.controller.execution_environment:
        name: "HomeLab EE"
        description: "Custom EE with Proxmox, Docker, and AAP Config collections"
        image: "{{ ee_image }}"
        pull: always
        organization: "{{ aap_organization }}"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    # -------------------------------------------------------
    # 3. Credentials
    # -------------------------------------------------------
    - name: Create Proxmox Credential
      ansible.controller.credential:
        name: "Proxmox Production"
        organization: "{{ aap_organization }}"
        credential_type: "Proxmox VE"
        inputs:
          host: "{{ proxmox_url }}"
          username: "{{ proxmox_user }}"
          token_id: "{{ proxmox_token_id }}"
          token_secret: "{{ proxmox_token_secret }}"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create Cloudflare Credential
      ansible.controller.credential:
        name: "Cloudflare DNS"
        organization: "{{ aap_organization }}"
        credential_type: "Cloudflare API"
        inputs:
          api_token: "{{ cloudflare_token }}"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create AAP SSH Key
      ansible.controller.credential:
        name: "AAP Executor SSH"
        organization: "{{ aap_organization }}"
        credential_type: "Machine"
        inputs:
          username: "root"
          ssh_key_data: "{{ ssh_private_key }}"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create Git Read-Only Credential
      ansible.controller.credential:
        name: "Git Read-Only"
        organization: "{{ aap_organization }}"
        credential_type: "Source Control"
        inputs:
          ssh_key_data: "{{ ssh_private_key }}" # Reusing same key for simplicity, ideally separate
          username: "git"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create DUMB Secrets Credential
      ansible.controller.credential:
        name: "DUMB Debrid Secrets"
        organization: "{{ aap_organization }}"
        credential_type: "DUMB Debrid Secrets"
        inputs:
          realdebrid_api_key: "{{ realdebrid_api_key }}"
          torbox_api_key: "{{ torbox_api_key }}"
          riven_api_key: "{{ riven_api_key }}"
          plex_token: "{{ plex_token }}"
          overseerr_api_key: "{{ overseerr_api_key }}"
          dumb_postgres_password: "{{ dumb_postgres_password }}"
          dumb_pgadmin_password: "{{ dumb_pgadmin_password }}"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no
      when: realdebrid_api_key != '' and torbox_api_key != ''

    - name: Create Media Arr Secrets Credential
      ansible.controller.credential:
        name: "Media Arr API Keys"
        organization: "{{ aap_organization }}"
        credential_type: "Media Arr API Keys"
        inputs:
          sonarr_api_key: "{{ sonarr_api_key }}"
          radarr_api_key: "{{ radarr_api_key }}"
          prowlarr_api_key: "{{ prowlarr_api_key }}"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no
      when: sonarr_api_key != '' and radarr_api_key != '' and prowlarr_api_key != ''

    - name: Create Pi-hole API Keys Credential
      ansible.controller.credential:
        name: "Pi-hole API Keys"
        organization: "{{ aap_organization }}"
        credential_type: "Pi-hole API Keys"
        inputs:
          key_116: "{{ lookup('env', 'PIHOLE_KEY_116') }}"
          key_100_2: "{{ lookup('env', 'PIHOLE_KEY_100_2') }}"
          key_110_100: "{{ lookup('env', 'PIHOLE_KEY_110_100') }}"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no
      when: lookup('env', 'PIHOLE_KEY_116') != ''

    # -------------------------------------------------------
    # 4. Project
    # -------------------------------------------------------
    - name: Create HomeLab Project
      ansible.controller.project:
        name: "HomeLab Ops"
        organization: "{{ aap_organization }}"
        scm_type: git
        scm_url: "git@github.com:sigtom/wow-ocp.git"
        scm_branch: "main"
        scm_clean: true
        scm_delete_on_update: true
        credential: "Git Read-Only"
        default_environment: "HomeLab EE"
        wait: yes # Wait for sync to complete
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Force Project Sync to discover new playbooks
      ansible.controller.project_update:
        project: "HomeLab Ops"
        wait: yes
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    # -------------------------------------------------------
    # 5. Inventory
    # -------------------------------------------------------
    - name: Create HomeLab Inventory
      ansible.controller.inventory:
        name: "HomeLab Inventory"
        organization: "{{ aap_organization }}"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    # -------------------------------------------------------
    # 6. Job Templates
    # -------------------------------------------------------
    - name: Create Test AAP Flow Job Template
      ansible.controller.job_template:
        name: "Test AAP Flow"
        job_type: run
        organization: "{{ aap_organization }}"
        inventory: "HomeLab Inventory"
        project: "HomeLab Ops"
        playbook: "automation/playbooks/test-aap-flow.yaml"
        execution_environment: "HomeLab EE"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create Deploy Traefik Job Template
      ansible.controller.job_template:
        name: "Deploy Traefik"
        job_type: run
        organization: "{{ aap_organization }}"
        inventory: "HomeLab Inventory"
        project: "HomeLab Ops"
        playbook: "automation/playbooks/deploy-traefik.yaml"
        execution_environment: "HomeLab EE"
        credentials:
          - "Proxmox Production"
          - "AAP Executor SSH"
          - "Cloudflare DNS"
        survey_enabled: true
        survey_spec:
          name: ""
          description: ""
          spec:
            - question_name: "Container ID"
              question_description: ""
              required: true
              type: integer
              variable: "target_vmid"
              min: 100
              max: 9999
              default: 210
            - question_name: "IP Address"
              question_description: ""
              required: true
              type: text
              variable: "target_ip"
              default: "172.16.100.10"
            - question_name: "Hostname"
              question_description: ""
              required: true
              type: text
              variable: "target_hostname"
              default: "traefik.sigtom.dev"
        extra_vars:
          vmid: "{% raw %}{{ target_vmid }}{% endraw %}"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create Setup Proxmox NFS Job Template
      ansible.controller.job_template:
        name: "Setup Proxmox NFS"
        description: "Mount TrueNAS NFS share on Proxmox host"
        job_type: run
        organization: "{{ aap_organization }}"
        inventory: "HomeLab Inventory"
        project: "HomeLab Ops"
        playbook: "automation/playbooks/setup-proxmox-nfs.yaml"
        execution_environment: "HomeLab EE"
        credentials:
          - "AAP Executor SSH"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    # -------------------------------------------------------
    # 7. Modular Job Templates for Workflow
    # -------------------------------------------------------
    
    - name: Create Validate IP Job Template
      ansible.controller.job_template:
        name: "Validate IP"
        description: "Check if IP is available (ping + rDNS)"
        job_type: run
        organization: "{{ aap_organization }}"
        inventory: "HomeLab Inventory"
        project: "HomeLab Ops"
        playbook: "automation/playbooks/validate-ip.yaml"
        execution_environment: "HomeLab EE"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create Provision LXC Job Template
      ansible.controller.job_template:
        name: "Provision LXC"
        description: "Create LXC container on Proxmox"
        job_type: run
        organization: "{{ aap_organization }}"
        inventory: "HomeLab Inventory"
        project: "HomeLab Ops"
        playbook: "automation/playbooks/provision-lxc.yaml"
        execution_environment: "HomeLab EE"
        credentials:
          - "Proxmox Production"
          - "AAP Executor SSH"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create Provision Media LXC Job Template
      ansible.controller.job_template:
        name: "Provision Media LXC"
        description: "Create LXC container on Proxmox with NAS mount"
        job_type: run
        organization: "{{ aap_organization }}"
        inventory: "HomeLab Inventory"
        project: "HomeLab Ops"
        playbook: "automation/playbooks/provision-media-lxc.yaml"
        execution_environment: "HomeLab EE"
        credentials:
          - "Proxmox Production"
          - "AAP Executor SSH"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create Install Docker Job Template
      ansible.controller.job_template:
        name: "Install Docker"
        description: "Install Docker and Docker Compose on target host"
        job_type: run
        organization: "{{ aap_organization }}"
        inventory: "HomeLab Inventory"
        project: "HomeLab Ops"
        playbook: "automation/playbooks/install-docker.yaml"
        execution_environment: "HomeLab EE"
        credentials:
          - "AAP Executor SSH"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    # -------------------------------------------------------
    # 8. Workflow Templates
    # -------------------------------------------------------
    
    - name: Create Provision Media Docker LXC Workflow
      ansible.controller.workflow_job_template:
        name: "Provision Media Docker LXC"
        description: "Complete workflow: Validate IP → Create Media LXC → Install Docker"
        organization: "{{ aap_organization }}"
        inventory: "HomeLab Inventory"
        survey_enabled: true
        survey_spec:
          name: "Media LXC Parameters"
          description: "Configure the new Media Docker LXC container"
          spec:
            - question_name: "Container ID (VMID)"
              required: true
              type: integer
              variable: "target_vmid"
              default: 221
            - question_name: "IP Address"
              required: true
              type: text
              variable: "target_ip"
              default: "172.16.100.21"
            - question_name: "Hostname"
              required: true
              type: text
              variable: "target_hostname"
              default: "downloaders"
            - question_name: "Size"
              required: true
              type: multiplechoice
              variable: "tshirt_size"
              choices: ["small", "medium", "large", "xlarge"]
              default: "medium"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Setup Workflow Nodes for Media LXC
      block:
        - name: Create Node - Validate IP
          ansible.controller.workflow_job_template_node:
            workflow_job_template: "Provision Media Docker LXC"
            identifier: "validate_ip"
            unified_job_template: "Validate IP"
            organization: "{{ aap_organization }}"
            state: present
            controller_host: "{{ controller_host }}"
            controller_username: "{{ controller_username }}"
            controller_password: "{{ controller_password }}"
            validate_certs: no

        - name: Create Node - Provision Media LXC
          ansible.controller.workflow_job_template_node:
            workflow_job_template: "Provision Media Docker LXC"
            identifier: "provision_media_lxc"
            unified_job_template: "Provision Media LXC"
            organization: "{{ aap_organization }}"
            state: present
            controller_host: "{{ controller_host }}"
            controller_username: "{{ controller_username }}"
            controller_password: "{{ controller_password }}"
            validate_certs: no

        - name: Create Node - Install Docker
          ansible.controller.workflow_job_template_node:
            workflow_job_template: "Provision Media Docker LXC"
            identifier: "install_docker"
            unified_job_template: "Install Docker"
            organization: "{{ aap_organization }}"
            state: present
            controller_host: "{{ controller_host }}"
            controller_username: "{{ controller_username }}"
            controller_password: "{{ controller_password }}"
            validate_certs: no

        - name: Link Node 1 → Node 2
          ansible.controller.workflow_job_template_node:
            workflow_job_template: "Provision Media Docker LXC"
            identifier: "validate_ip"
            success_nodes: ["provision_media_lxc"]
            organization: "{{ aap_organization }}"
            state: present
            controller_host: "{{ controller_host }}"
            controller_username: "{{ controller_username }}"
            controller_password: "{{ controller_password }}"
            validate_certs: no

        - name: Link Node 2 → Node 3
          ansible.controller.workflow_job_template_node:
            workflow_job_template: "Provision Media Docker LXC"
            identifier: "provision_media_lxc"
            success_nodes: ["install_docker"]
            organization: "{{ aap_organization }}"
            state: present
            controller_host: "{{ controller_host }}"
            controller_username: "{{ controller_username }}"
            controller_password: "{{ controller_password }}"
            validate_certs: no

    # -------------------------------------------------------
    # 9. Application Deployment Job Templates
    # -------------------------------------------------------

    - name: Create Deploy DUMB Job Template
      ansible.controller.job_template:
        name: "Deploy DUMB"
        description: "Deploy DUMB (Debrid Unlimited Media Bridge) to Docker LXC"
        job_type: run
        organization: "{{ aap_organization }}"
        inventory: "HomeLab Inventory"
        project: "HomeLab Ops"
        playbook: "automation/playbooks/deploy-dumb.yaml"
        execution_environment: "HomeLab EE"
        credentials:
          - "AAP Executor SSH"
          - "DUMB Debrid Secrets"
          - "Media Arr API Keys"
        survey_enabled: true
        survey_spec:
          name: "DUMB Deployment Parameters"
          description: "Configure DUMB deployment target"
          spec:
            - question_name: "Target IP"
              required: true
              type: text
              variable: "target_ip"
              default: "172.16.100.20"
            - question_name: "Hostname"
              required: true
              type: text
              variable: "target_hostname"
              default: "dumb"
            - question_name: "Plex Claim Token"
              question_description: "Get from https://www.plex.tv/claim/"
              required: false
              type: text
              variable: "plex_claim_token"
              default: ""
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create Deploy Downloaders Job Template
      ansible.controller.job_template:
        name: "Deploy Downloaders"
        description: "Deploy qBittorrent and Sabnzbd to Docker LXC"
        job_type: run
        organization: "{{ aap_organization }}"
        inventory: "HomeLab Inventory"
        project: "HomeLab Ops"
        playbook: "automation/playbooks/deploy-downloaders.yaml"
        execution_environment: "HomeLab EE"
        credentials:
          - "AAP Executor SSH"
        survey_enabled: true
        survey_spec:
          name: "Downloaders Deployment Parameters"
          description: "Configure Downloaders deployment target"
          spec:
            - question_name: "Target IP"
              required: true
              type: text
              variable: "target_ip"
              default: "172.16.100.21"
            - question_name: "Hostname"
              required: true
              type: text
              variable: "target_hostname"
              default: "downloaders"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create Deploy Docker Socket Proxy Job Template
      ansible.controller.job_template:
        name: "Deploy Docker Socket Proxy"
        description: "Deploy secure Docker socket proxy for remote Traefik discovery"
        job_type: run
        organization: "{{ aap_organization }}"
        inventory: "HomeLab Inventory"
        project: "HomeLab Ops"
        playbook: "automation/playbooks/deploy-socket-proxy.yaml"
        execution_environment: "HomeLab EE"
        credentials:
          - "AAP Executor SSH"
        survey_enabled: true
        survey_spec:
          name: "Socket Proxy Parameters"
          description: "Configure target for Docker socket proxy"
          spec:
            - question_name: "Target IP"
              required: true
              type: text
              variable: "target_ip"
            - question_name: "Hostname"
              required: true
              type: text
              variable: "target_hostname"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create Seed Arr Configs Job Template
      ansible.controller.job_template:
        name: "Seed Arr Configs"
        description: "Configure Quality Profiles and Custom Formats in Sonarr and Radarr"
        job_type: run
        organization: "{{ aap_organization }}"
        inventory: "HomeLab Inventory"
        project: "HomeLab Ops"
        playbook: "automation/playbooks/seed-arr-configs.yaml"
        execution_environment: "HomeLab EE"
        credentials:
          - "Media Arr API Keys"
        survey_enabled: true
        survey_spec:
          name: "Arr Seeder Parameters"
          description: "Configure Arr seeder target"
          spec:
            - question_name: "LXC IP"
              required: true
              type: text
              variable: "lxc_ip"
              default: "172.16.100.20"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create Sync DNS to Pi-holes Job Template
      ansible.controller.job_template:
        name: "Sync DNS to Pi-holes"
        description: "Synchronize local DNS records across all Pi-hole instances"
        job_type: run
        organization: "{{ aap_organization }}"
        inventory: "HomeLab Inventory"
        project: "HomeLab Ops"
        playbook: "automation/playbooks/sync-pihole-dns.yaml"
        execution_environment: "HomeLab EE"
        credentials:
          - "Pi-hole API Keys"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create Setup Docker Swarm Job Template
      ansible.controller.job_template:
        name: "Setup Docker Swarm"
        description: "Initialize Docker Swarm across LXC nodes for Traefik discovery"
        job_type: run
        organization: "{{ aap_organization }}"
        inventory: "HomeLab Inventory"
        project: "HomeLab Ops"
        playbook: "automation/playbooks/setup-docker-swarm.yaml"
        execution_environment: "HomeLab EE"
        credentials:
          - "AAP Executor SSH"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no

    - name: Create Debug Traefik Job Template
      ansible.controller.job_template:
        name: "Debug Traefik"
        job_type: run
        organization: "{{ aap_organization }}"
        inventory: "HomeLab Inventory"
        project: "HomeLab Ops"
        playbook: "automation/playbooks/debug-traefik.yaml"
        execution_environment: "HomeLab EE"
        credentials:
          - "AAP Executor SSH"
        state: present
        controller_host: "{{ controller_host }}"
        controller_username: "{{ controller_username }}"
        controller_password: "{{ controller_password }}"
        validate_certs: no
