---
# Basic Health Checks
# Runs foundational checks: connectivity, disk space, uptime

- name: Check SSH connectivity
  ansible.builtin.ping:
  register: ssh_check
  ignore_errors: true

- name: Record SSH status (Success)
  ansible.builtin.set_fact:
    health_check_results: "{{ health_check_results + [ {'check': 'SSH Connectivity', 'status': 'PASS', 'details': 'Host is reachable'} ] }}"
  when: ssh_check is success

- name: Record SSH status (Failure)
  ansible.builtin.set_fact:
    health_check_results: "{{ health_check_results + [ {'check': 'SSH Connectivity', 'status': 'FAIL', 'details': 'Host unreachable'} ] }}"
  when: ssh_check is failed

- name: Record Cloud-Init Status (LXC)
  ansible.builtin.set_fact:
    health_check_results: "{{ health_check_results + [ {'check': 'Cloud-Init Status', 'status': 'SKIP', 'details': 'Skipped for LXC container'} ] }}"
  when: is_lxc

- name: Check Cloud-Init Status (VM/Host)
  block:
    - name: Check cloud-init status command
      ansible.builtin.command: cloud-init status
      register: cloud_init_status
      changed_when: false
      failed_when: false

    - name: Record Cloud-Init status (Done)
      ansible.builtin.set_fact:
        health_check_results: "{{ health_check_results + [ {'check': 'Cloud-Init Status', 'status': 'PASS', 'details': 'Configuration complete'} ] }}"
      when: "'done' in cloud_init_status.stdout"

    - name: Record Cloud-Init status (Running/Error)
      ansible.builtin.set_fact:
        health_check_results: "{{ health_check_results + [ {'check': 'Cloud-Init Status', 'status': 'WARN', 'details': 'Status: ' + cloud_init_status.stdout} ] }}"
      when: "'done' not in cloud_init_status.stdout"
  when: not is_lxc
  rescue:
    - name: Record Cloud-Init check failure
      ansible.builtin.set_fact:
        health_check_results: "{{ health_check_results + [ {'check': 'Cloud-Init Status', 'status': 'SKIP', 'details': 'cloud-init not installed or check failed'} ] }}"

- name: Check Disk Space
  block:
    - name: Get disk usage
      ansible.builtin.shell: "df -h / | tail -n 1 | awk '{print $5}' | tr -d '%'"
      register: disk_usage
      changed_when: false

    - name: Record Disk Space (Healthy)
      ansible.builtin.set_fact:
        health_check_results: "{{ health_check_results + [ {'check': 'Disk Space', 'status': 'PASS', 'details': 'Usage: ' + disk_usage.stdout + '%'} ] }}"
      when: disk_usage.stdout | int < 90

    - name: Record Disk Space (Critical)
      ansible.builtin.set_fact:
        health_check_results: "{{ health_check_results + [ {'check': 'Disk Space', 'status': 'FAIL', 'details': 'Critical usage: ' + disk_usage.stdout + '%'} ] }}"
      when: disk_usage.stdout | int >= 90
  rescue:
    - name: Record Disk Space check failure
      ansible.builtin.set_fact:
        health_check_results: "{{ health_check_results + [ {'check': 'Disk Space', 'status': 'FAIL', 'details': 'Could not determine disk usage'} ] }}"

- name: Check Uptime
  block:
    - name: Get uptime
      ansible.builtin.command: uptime -p
      register: uptime_check
      changed_when: false

    - name: Record Uptime
      ansible.builtin.set_fact:
        health_check_results: "{{ health_check_results + [ {'check': 'System Uptime', 'status': 'PASS', 'details': uptime_check.stdout} ] }}"
  rescue:
    - name: Record Uptime check failure
      ansible.builtin.set_fact:
        health_check_results: "{{ health_check_results + [ {'check': 'System Uptime', 'status': 'FAIL', 'details': 'Could not determine uptime'} ] }}"

- name: Check Package Manager Lock
  block:
    - name: Check apt lock (Debian/Ubuntu)
      ansible.builtin.shell: "lsof /var/lib/dpkg/lock-frontend || echo 'unlocked'"
      register: apt_lock
      changed_when: false
      failed_when: false
      become: yes
      when:
        - ansible_facts['os_family'] is defined
        - ansible_facts['os_family'] == "Debian"

    - name: Record apt lock status
      ansible.builtin.set_fact:
        health_check_results: "{{ health_check_results + [ {'check': 'Package Manager', 'status': 'PASS', 'details': 'APT is unlocked'} ] }}"
      when:
        - ansible_facts['os_family'] is defined
        - ansible_facts['os_family'] == "Debian"
        - "'unlocked' in apt_lock.stdout"

    - name: Record apt lock failure
      ansible.builtin.set_fact:
        health_check_results: "{{ health_check_results + [ {'check': 'Package Manager', 'status': 'FAIL', 'details': 'APT is locked (running update?)'} ] }}"
      when:
        - ansible_facts['os_family'] is defined
        - ansible_facts['os_family'] == "Debian"
        - "'unlocked' not in apt_lock.stdout"

    - name: Check dnf lock (RedHat/Fedora)
      ansible.builtin.shell: "lsof /var/lib/rpm/.rpm.lock || echo 'unlocked'"
      register: dnf_lock
      changed_when: false
      failed_when: false
      become: yes
      when:
        - ansible_facts['os_family'] is defined
        - ansible_facts['os_family'] == "RedHat"

    - name: Record dnf lock status
      ansible.builtin.set_fact:
        health_check_results: "{{ health_check_results + [ {'check': 'Package Manager', 'status': 'PASS', 'details': 'DNF is unlocked'} ] }}"
      when:
        - ansible_facts['os_family'] is defined
        - ansible_facts['os_family'] == "RedHat"
        - "'unlocked' in dnf_lock.stdout"
