---
# Phase 2: Docker Setup
# - Create directory structure
# - Generate or retrieve secrets
# - Deploy docker-compose.yml and .env
# - Start containers

- name: Create Nautobot directory structure
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  become: yes
  loop:
    - "{{ nautobot_base_dir }}"
    - "{{ nautobot_postgres_dir }}"
    - "{{ nautobot_redis_dir }}"
    - "{{ nautobot_data_dir }}"
    - "{{ nautobot_data_dir }}/media"
    - "{{ nautobot_data_dir }}/git"
    - "{{ nautobot_data_dir }}/jobs"
    - "{{ nautobot_data_dir }}/static"
    - "{{ nautobot_nginx_dir }}"

- name: Check if .env file already exists
  ansible.builtin.stat:
    path: "{{ nautobot_base_dir }}/.env"
  register: env_file_check

- name: Generate PostgreSQL password if not provided
  ansible.builtin.set_fact:
    nautobot_db_password: "{{ lookup('env', 'NAUTOBOT_DB_PASSWORD') | default(lookup('password', '/dev/null length=32 chars=ascii_letters,digits'), true) }}"
  when: not env_file_check.stat.exists

- name: Generate Redis password if not provided
  ansible.builtin.set_fact:
    nautobot_redis_password: "{{ lookup('env', 'NAUTOBOT_REDIS_PASSWORD') | default(lookup('password', '/dev/null length=32 chars=ascii_letters,digits'), true) }}"
  when: not env_file_check.stat.exists

- name: Generate Nautobot secret key if not provided
  ansible.builtin.set_fact:
    nautobot_secret_key: "{{ lookup('env', 'NAUTOBOT_SECRET_KEY') | default(lookup('password', '/dev/null length=64 chars=ascii_letters,digits'), true) }}"
  when: not env_file_check.stat.exists

- name: Read existing secrets from .env if it exists
  ansible.builtin.slurp:
    path: "{{ nautobot_base_dir }}/.env"
  register: existing_env
  when: env_file_check.stat.exists

- name: Parse existing secrets
  ansible.builtin.set_fact:
    nautobot_db_password: "{{ existing_env.content | b64decode | regex_search('POSTGRES_PASSWORD=(.+)', '\\1') | first }}"
    nautobot_redis_password: "{{ existing_env.content | b64decode | regex_search('REDIS_PASSWORD=(.+)', '\\1') | first }}"
    nautobot_secret_key: "{{ existing_env.content | b64decode | regex_search('NAUTOBOT_SECRET_KEY=(.+)', '\\1') | first }}"
  when: env_file_check.stat.exists

- name: Deploy .env configuration
  ansible.builtin.template:
    src: .env.j2
    dest: "{{ nautobot_base_dir }}/.env"
    mode: '0600'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Deploy docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ nautobot_base_dir }}/docker-compose.yml"
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Deploy local_requirements.txt for plugins
  ansible.builtin.copy:
    content: |
      # Nautobot Plugins
      {% for plugin in nautobot_plugins %}
      {{ plugin }}
      {% endfor %}
    dest: "{{ nautobot_base_dir }}/local_requirements.txt"
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Check if containers are already running
  ansible.builtin.command: docker compose -f {{ nautobot_base_dir }}/docker-compose.yml ps -q
  register: containers_check
  changed_when: false
  ignore_errors: yes

- name: Pull Docker images
  ansible.builtin.command: docker compose -f {{ nautobot_base_dir }}/docker-compose.yml pull
  args:
    chdir: "{{ nautobot_base_dir }}"
  when: containers_check.stdout == ""

- name: Start Docker Compose services
  ansible.builtin.command: docker compose -f {{ nautobot_base_dir }}/docker-compose.yml up -d
  args:
    chdir: "{{ nautobot_base_dir }}"
  register: compose_up

- name: Wait for PostgreSQL to be healthy
  ansible.builtin.command: docker compose -f {{ nautobot_base_dir }}/docker-compose.yml exec -T postgres pg_isready -U {{ postgres_user }}
  args:
    chdir: "{{ nautobot_base_dir }}"
  register: postgres_ready
  retries: 30
  delay: 5
  until: postgres_ready.rc == 0
  changed_when: false

- name: Wait for Redis to be healthy
  ansible.builtin.command: docker compose -f {{ nautobot_base_dir }}/docker-compose.yml exec -T redis redis-cli ping
  args:
    chdir: "{{ nautobot_base_dir }}"
  register: redis_ready
  retries: 10
  delay: 3
  until: "'PONG' in redis_ready.stdout"
  changed_when: false

- name: Display container status
  ansible.builtin.command: docker compose -f {{ nautobot_base_dir }}/docker-compose.yml ps
  args:
    chdir: "{{ nautobot_base_dir }}"
  register: compose_ps
  changed_when: false

- name: Show container status
  ansible.builtin.debug:
    var: compose_ps.stdout_lines
