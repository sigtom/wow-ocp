---
# Phase 4: Initialize Nautobot
# - Run database migrations
# - Create superuser
# - Collect static files

- name: Wait for Nautobot web container to be fully ready
  ansible.builtin.pause:
    seconds: 10

- name: Check if migrations have been run
  ansible.builtin.command: >
    docker compose -f {{ nautobot_base_dir }}/docker-compose.yml exec -T nautobot
    nautobot-server showmigrations --plan
  args:
    chdir: "{{ nautobot_base_dir }}"
  register: migrations_check
  changed_when: false
  ignore_errors: yes

- name: Run database migrations
  ansible.builtin.command: >
    docker compose -f {{ nautobot_base_dir }}/docker-compose.yml exec -T nautobot
    nautobot-server migrate
  args:
    chdir: "{{ nautobot_base_dir }}"
  register: migrate_result
  when: migrations_check.rc == 0

- name: Display migration results
  ansible.builtin.debug:
    var: migrate_result.stdout_lines
  when: migrate_result is defined and migrate_result.stdout_lines is defined

- name: Check if superuser already exists
  ansible.builtin.command: >
    docker compose -f {{ nautobot_base_dir }}/docker-compose.yml exec -T postgres
    psql -U {{ postgres_user }} -d {{ postgres_db }} -tAc
    "SELECT COUNT(*) FROM auth_user WHERE username='{{ nautobot_superuser_username }}';"
  args:
    chdir: "{{ nautobot_base_dir }}"
  register: superuser_check
  changed_when: false

- name: Get superuser password from environment
  ansible.builtin.set_fact:
    nautobot_superuser_password: "{{ lookup('env', 'NAUTOBOT_SUPERUSER_PASSWORD') }}"
  when: superuser_check.stdout.strip() == "0"

- name: Fail if superuser password not provided
  ansible.builtin.fail:
    msg: "NAUTOBOT_SUPERUSER_PASSWORD environment variable must be set for superuser creation"
  when:
    - superuser_check.stdout.strip() == "0"
    - nautobot_superuser_password == ""

- name: Create superuser using Django environment variables
  ansible.builtin.command: >
    docker compose -f {{ nautobot_base_dir }}/docker-compose.yml exec -T
    -e DJANGO_SUPERUSER_USERNAME={{ nautobot_superuser_username }}
    -e DJANGO_SUPERUSER_EMAIL={{ nautobot_superuser_email }}
    -e DJANGO_SUPERUSER_PASSWORD={{ nautobot_superuser_password }}
    nautobot
    nautobot-server createsuperuser --noinput
  args:
    chdir: "{{ nautobot_base_dir }}"
  when: superuser_check.stdout.strip() == "0"
  register: superuser_result
  no_log: true

- name: Display superuser creation result (sanitized)
  ansible.builtin.debug:
    msg: "Superuser '{{ nautobot_superuser_username }}' created successfully"
  when: superuser_check.stdout.strip() == "0" and superuser_result.rc == 0

- name: Check if static files already collected
  ansible.builtin.stat:
    path: "{{ nautobot_data_dir }}/static/admin"
  register: static_files_check

- name: Collect static files
  ansible.builtin.command: >
    docker compose -f {{ nautobot_base_dir }}/docker-compose.yml exec -T nautobot
    nautobot-server collectstatic --no-input
  args:
    chdir: "{{ nautobot_base_dir }}"
  when: not static_files_check.stat.exists
  register: collectstatic_result

- name: Display collectstatic results
  ansible.builtin.debug:
    var: collectstatic_result.stdout_lines
  when: collectstatic_result is defined and collectstatic_result.stdout_lines is defined

- name: Restart Nautobot containers to apply all changes
  ansible.builtin.command: docker compose -f {{ nautobot_base_dir }}/docker-compose.yml restart
  args:
    chdir: "{{ nautobot_base_dir }}"
  register: restart_result

- name: Wait for containers to restart
  ansible.builtin.pause:
    seconds: 15

- name: Verify all containers are running
  ansible.builtin.command: docker compose -f {{ nautobot_base_dir }}/docker-compose.yml ps
  args:
    chdir: "{{ nautobot_base_dir }}"
  register: final_ps
  changed_when: false

- name: Display final container status
  ansible.builtin.debug:
    var: final_ps.stdout_lines
