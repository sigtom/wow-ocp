---
# Phase 3: SSL/HTTPS Setup
# - Install NGINX
# - Deploy NGINX configuration
# - Obtain Let's Encrypt certificate with certbot
# - Enable NGINX service

- name: Install NGINX and Certbot
  ansible.builtin.apt:
    name:
      - nginx
      - certbot
      - python3-certbot-nginx
    state: present
    update_cache: yes
  become: yes

- name: Check if SSL certificate already exists
  ansible.builtin.stat:
    path: "/etc/letsencrypt/live/{{ nautobot_domain }}/fullchain.pem"
  register: ssl_cert_check
  become: yes

- name: Deploy NGINX configuration for Nautobot (HTTP only for initial setup)
  ansible.builtin.template:
    src: nginx-nautobot.conf.j2
    dest: /etc/nginx/sites-available/nautobot
    mode: '0644'
  become: yes

- name: Enable Nautobot site in NGINX
  ansible.builtin.file:
    src: /etc/nginx/sites-available/nautobot
    dest: /etc/nginx/sites-enabled/nautobot
    state: link
  become: yes

- name: Remove default NGINX site
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  become: yes

- name: Test NGINX configuration
  ansible.builtin.command: nginx -t
  become: yes
  changed_when: false

- name: Restart NGINX
  ansible.builtin.systemd:
    name: nginx
    state: restarted
    enabled: yes
  become: yes

- name: Wait for NGINX to start
  ansible.builtin.wait_for:
    port: 80
    delay: 2
    timeout: 30

- name: Obtain Let's Encrypt SSL certificate
  ansible.builtin.command: >
    certbot --nginx
    -d {{ nautobot_domain }}
    --non-interactive
    --agree-tos
    -m {{ letsencrypt_email }}
    --redirect
  become: yes
  when: not ssl_cert_check.stat.exists
  register: certbot_result

- name: Display certbot result
  ansible.builtin.debug:
    var: certbot_result.stdout_lines
  when: not ssl_cert_check.stat.exists

- name: Test certbot renewal (dry run)
  ansible.builtin.command: certbot renew --dry-run
  become: yes
  when: not ssl_cert_check.stat.exists
  register: certbot_dryrun
  changed_when: false

- name: Reload NGINX after SSL setup
  ansible.builtin.systemd:
    name: nginx
    state: reloaded
  become: yes

- name: Verify HTTPS access
  ansible.builtin.uri:
    url: "https://{{ nautobot_domain }}"
    validate_certs: yes
    status_code: [200, 301, 302]
  register: https_check
  retries: 3
  delay: 5
  until: https_check.status in [200, 301, 302]
  ignore_errors: yes

- name: Display HTTPS check result
  ansible.builtin.debug:
    msg: "HTTPS access: {{ 'SUCCESS' if https_check.status in [200, 301, 302] else 'FAILED' }}"
