version: '3.8'

services:
  postgres:
    image: postgres:{{ postgres_version }}
    container_name: nautobot-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: {{ postgres_user }}
      POSTGRES_PASSWORD: {{ nautobot_db_password }}
      POSTGRES_DB: {{ postgres_db }}
    volumes:
      - {{ nautobot_postgres_dir }}:/var/lib/postgresql/data
    networks:
      - nautobot-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{ postgres_user }}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:{{ redis_version }}
    container_name: nautobot-redis
    restart: unless-stopped
    command: redis-server --requirepass {{ nautobot_redis_password }}
    volumes:
      - {{ nautobot_redis_dir }}:/data
    networks:
      - nautobot-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  nautobot:
    image: networktocode/nautobot:{{ nautobot_version }}
    container_name: nautobot-web
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      NAUTOBOT_DB_ENGINE: django.db.backends.postgresql
      NAUTOBOT_DB_HOST: postgres
      NAUTOBOT_DB_NAME: {{ postgres_db }}
      NAUTOBOT_DB_USER: {{ postgres_user }}
      NAUTOBOT_DB_PASSWORD: {{ nautobot_db_password }}
      NAUTOBOT_REDIS_HOST: redis
      NAUTOBOT_REDIS_PASSWORD: {{ nautobot_redis_password }}
      NAUTOBOT_SECRET_KEY: {{ nautobot_secret_key }}
      NAUTOBOT_ALLOWED_HOSTS: {{ nautobot_domain }},{{ ansible_host }},localhost
      NAUTOBOT_INSTALLATION_METRICS_ENABLED: "{{ nautobot_metrics_enabled }}"
      TZ: {{ nautobot_timezone }}
    volumes:
      - {{ nautobot_data_dir }}/media:/opt/nautobot/media
      - {{ nautobot_data_dir }}/git:/opt/nautobot/git
      - {{ nautobot_data_dir }}/jobs:/opt/nautobot/jobs
      - {{ nautobot_data_dir }}/static:/opt/nautobot/static
    ports:
      - "{{ nautobot_web_port }}:8080"
    networks:
      - nautobot-net
    command: nautobot-server start --ini /opt/nautobot/uwsgi.ini

  nautobot-worker:
    image: networktocode/nautobot:{{ nautobot_version }}
    container_name: nautobot-worker
    restart: unless-stopped
    depends_on:
      - nautobot
    environment:
      NAUTOBOT_DB_ENGINE: django.db.backends.postgresql
      NAUTOBOT_DB_HOST: postgres
      NAUTOBOT_DB_NAME: {{ postgres_db }}
      NAUTOBOT_DB_USER: {{ postgres_user }}
      NAUTOBOT_DB_PASSWORD: {{ nautobot_db_password }}
      NAUTOBOT_REDIS_HOST: redis
      NAUTOBOT_REDIS_PASSWORD: {{ nautobot_redis_password }}
      NAUTOBOT_SECRET_KEY: {{ nautobot_secret_key }}
      TZ: {{ nautobot_timezone }}
    volumes:
      - {{ nautobot_data_dir }}/media:/opt/nautobot/media
      - {{ nautobot_data_dir }}/git:/opt/nautobot/git
      - {{ nautobot_data_dir }}/jobs:/opt/nautobot/jobs
    networks:
      - nautobot-net
    command: nautobot-server celery worker --loglevel INFO

  nautobot-scheduler:
    image: networktocode/nautobot:{{ nautobot_version }}
    container_name: nautobot-scheduler
    restart: unless-stopped
    depends_on:
      - nautobot
    environment:
      NAUTOBOT_DB_ENGINE: django.db.backends.postgresql
      NAUTOBOT_DB_HOST: postgres
      NAUTOBOT_DB_NAME: {{ postgres_db }}
      NAUTOBOT_DB_USER: {{ postgres_user }}
      NAUTOBOT_DB_PASSWORD: {{ nautobot_db_password }}
      NAUTOBOT_REDIS_HOST: redis
      NAUTOBOT_REDIS_PASSWORD: {{ nautobot_redis_password }}
      NAUTOBOT_SECRET_KEY: {{ nautobot_secret_key }}
      TZ: {{ nautobot_timezone }}
    volumes:
      - {{ nautobot_data_dir }}/media:/opt/nautobot/media
      - {{ nautobot_data_dir }}/git:/opt/nautobot/git
    networks:
      - nautobot-net
    command: nautobot-server celery beat --loglevel INFO

networks:
  nautobot-net:
    driver: bridge
