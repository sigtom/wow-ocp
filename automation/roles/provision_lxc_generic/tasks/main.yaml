---
# Generic LXC Container Provisioning Role - Main Tasks
# Refactored to use native community.general.proxmox module

- name: Validate lxc_templates is loaded
  ansible.builtin.assert:
    that:
      - lxc_templates is defined
      - lxc_tshirt_sizes is defined
    fail_msg: |
      Critical error: lxc_templates and lxc_tshirt_sizes not defined!
      These should be loaded from group_vars/all.yml
    success_msg: "Template registry loaded"

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - os_type is defined
      - os_type in lxc_templates
      - tshirt_size is defined
      - tshirt_size in lxc_tshirt_sizes
      - vmid is defined
      - proxmox_node is defined
      - inventory_hostname is defined
    fail_msg: "Missing required variables for LXC provisioning!"
    success_msg: "All required variables validated"

- name: Set facts from templates and sizes
  ansible.builtin.set_fact:
    template_filename: "{{ lxc_templates[os_type].filename }}"
    lxc_default_user: "{{ lxc_templates[os_type].default_user }}"
    lxc_cores: "{{ lxc_tshirt_sizes[tshirt_size].cores }}"
    lxc_memory: "{{ lxc_tshirt_sizes[tshirt_size].memory }}"
    lxc_disk_size: "{{ lxc_tshirt_sizes[tshirt_size].disk }}"
    size_description: "{{ lxc_tshirt_sizes[tshirt_size].description }}"
    proxmox_api_host: "{{ hostvars[proxmox_node].ansible_host }}"
    lxc_storage_backend: "{{ lxc_storage | default(proxmox_storage_backends[proxmox_node].lxc_storage) }}"
    network_config: "{{ network_profiles[network_profile | default('apps')] }}"

- name: Construct net0 dictionary
  ansible.builtin.set_fact:
    lxc_netif:
      net0: "name=eth0,bridge={{ network_config.bridge | default('vmbr0') }}{% if network_config.vlan is not none %},tag={{ network_config.vlan }}{% endif %},ip={{ 'dhcp' if network_mode == 'dhcp' else ansible_host + '/24' }}{% if network_mode == 'static' %},gw={{ network_config.gateway | default('172.16.100.1') }}{% endif %}"

- name: Construct mounts dictionary
  ansible.builtin.set_fact:
    lxc_mounts_dict: "{{ lxc_mounts_dict | default({}) | combine({ (my_idx | string): item }) }}"
  loop: "{{ lxc_mount_points | default([]) }}"
  loop_control:
    index_var: my_idx

- name: Display provisioning plan
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "LXC Container Provisioning Plan (Native)"
      - "=========================================="
      - "Hostname: {{ inventory_hostname }}"
      - "CTID: {{ vmid }}"
      - "Proxmox Node: {{ proxmox_node }}"
      - "OS: {{ os_type }} ({{ lxc_templates[os_type].description }})"
      - "Size: {{ tshirt_size }} ({{ size_description }})"
      - "Network: {{ network_mode }}"
      - "Netif: {{ lxc_netif }}"
      - "Storage: {{ lxc_storage_backend }}"
      - "=========================================="

- name: Check if container exists
  ansible.builtin.uri:
    url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/lxc/{{ vmid }}/status/current"
    method: GET
    headers:
      Authorization: "PVEAPIToken={{ pve_api_user }}!{{ pve_api_token_id }}={{ pve_api_token_secret }}"
    validate_certs: no
    status_code: [200, 404, 500]
  register: lxc_exists_check
  delegate_to: localhost
  check_mode: no

- name: Fail if container exists
  ansible.builtin.fail:
    msg: "LXC ID {{ vmid }} already exists!"
  when:
    - lxc_exists_check.status == 200
    - not skip_existing_check
  check_mode: no

- name: Provision LXC container using native module
  community.general.proxmox:
    api_host: "{{ proxmox_api_host }}"
    api_user: "{{ pve_api_user }}"
    api_token_id: "{{ pve_api_token_id }}"
    api_token_secret: "{{ pve_api_token_secret }}"
    node: "{{ proxmox_node }}"
    vmid: "{{ vmid }}"
    hostname: "{{ inventory_hostname }}"
    ostemplate: "{{ lxc_storage_backend }}:vztmpl/{{ template_filename }}"
    cores: "{{ lxc_cores }}"
    memory: "{{ lxc_memory }}"
    disk: "{{ lxc_disk_size }}"
    storage: "{{ lxc_storage_backend }}"
    netif: "{{ lxc_netif }}"
    features: "{{ lxc_features }}"
    unprivileged: "{{ lxc_unprivileged }}"
    pubkey: "{{ global_ssh_keys | join('\n') }}"
    mounts: "{{ lxc_mounts_dict | default(omit) }}"
    validate_certs: no
    state: present
    timeout: "{{ create_wait_time }}"
  delegate_to: localhost
  register: lxc_provision_result
  when: lxc_exists_check.status != 200 or skip_existing_check

- name: Wait for LXC to boot and get IP
  block:
    - name: Start container if not running
      community.general.proxmox:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ pve_api_user }}"
        api_token_id: "{{ pve_api_token_id }}"
        api_token_secret: "{{ pve_api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ vmid }}"
        validate_certs: no
        state: started
      delegate_to: localhost
      register: lxc_start_wait
      until: "lxc_start_wait.status | default('') == 'running'"
      retries: 10
      delay: 5
      check_mode: no

    - name: Get LXC IP address (DHCP mode)
      ansible.builtin.shell: |
        ssh -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ proxmox_api_host }} \
        "pct exec {{ vmid }} -- ip -4 addr show eth0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}'"
      register: discovered_ip
      delegate_to: localhost
      retries: 12
      delay: 10
      until: discovered_ip.stdout != "" and not discovered_ip.stdout.startswith("127.")
      when: network_mode == 'dhcp'
      check_mode: no

    - name: Wait for SSH to be ready (static IP mode)
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 22
        delay: 5
        timeout: "{{ ssh_wait_timeout }}"
      delegate_to: localhost
      when: network_mode == 'static'
      check_mode: no
  when:
    - not ansible_check_mode
    - start_lxc

- name: Run health checks
  ansible.builtin.include_role:
    name: health_check
  vars:
    health_check_profile: "{{ hostvars[inventory_hostname].health_check_profile | default('basic') }}"
  when:
    - not ansible_check_mode
    - start_lxc
    - health_check_enabled
    - lxc_provision_result.changed | default(false) or skip_existing_check

- name: Run post-provisioning
  ansible.builtin.include_role:
    name: post_provision
  vars:
    post_provisioning_profile: "{{ hostvars[inventory_hostname].post_provisioning_profile | default('none') }}"
  when:
    - not ansible_check_mode
    - start_lxc
    - post_provisioning_enabled
    - lxc_provision_result.changed | default(false) or skip_existing_check
