---
# Generic VM Provisioning Role - Main Tasks
# Refactored to be forceful and bypass flakey Cloud-Init/API behaviors

- name: Validate vm_templates is loaded
  ansible.builtin.assert:
    that:
      - vm_templates is defined
      - vm_tshirt_sizes is defined
    fail_msg: "Critical error: vm_templates and vm_tshirt_sizes not defined!"

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - os_type is defined
      - os_type in vm_templates
      - tshirt_size is defined
      - tshirt_size in vm_tshirt_sizes
      - vmid is defined
      - proxmox_node is defined
    fail_msg: "Missing required variables for VM provisioning!"

- name: Set facts from templates and sizes
  ansible.builtin.set_fact:
    template_vmid: "{{ vm_templates[os_type].vmid }}"
    vm_cores: "{{ vm_tshirt_sizes[tshirt_size].cores }}"
    vm_memory: "{{ vm_tshirt_sizes[tshirt_size].memory }}"
    vm_disk_size: "{{ vm_tshirt_sizes[tshirt_size].disk }}"
    proxmox_api_host: "{{ hostvars[proxmox_node].ansible_host }}"
    vm_storage_backend: "{{ vm_storage | default(proxmox_storage_backends[proxmox_node].vm_storage) }}"
    network_config: "{{ network_profiles[network_profile | default('apps')] }}"

- name: Construct net0 string
  ansible.builtin.set_fact:
    vm_net0: "virtio,bridge={{ network_config.bridge | default('vmbr0') }}{% if network_config.vlan is not none %},tag={{ network_config.vlan }}{% endif %}"

- name: Check if VM exists
  ansible.builtin.uri:
    url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/qemu/{{ vmid }}/status/current"
    method: GET
    headers:
      Authorization: "PVEAPIToken={{ pve_api_user }}!{{ pve_api_token_id }}={{ pve_api_token_secret }}"
    validate_certs: no
    status_code: [200, 404, 500]
  register: vm_exists_check
  delegate_to: localhost

- name: Provision VM using native module (Clone)
  community.proxmox.proxmox_kvm:
    api_host: "{{ proxmox_api_host }}"
    api_user: "{{ pve_api_user }}"
    api_token_id: "{{ pve_api_token_id }}"
    api_token_secret: "{{ pve_api_token_secret }}"
    node: "{{ proxmox_node }}"
    vmid: "{{ template_vmid }}"
    newid: "{{ vmid }}"
    name: "{{ inventory_hostname }}"
    clone: "{{ template_vmid }}"
    full: "{{ clone_full }}"
    storage: "{{ vm_storage_backend if clone_full else omit }}"
    validate_certs: no
    state: present
    timeout: "{{ clone_wait_time }}"
  delegate_to: localhost
  register: vm_provision_result
  when: vm_exists_check.status != 200

- name: Force Apply Configuration and Hardware Specs
  ansible.builtin.shell: |
    ssh -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ proxmox_api_host }} \
    "qm set {{ vmid }} --name {{ inventory_hostname }} --cores {{ vm_cores }} --memory {{ vm_memory }} --net0 {{ vm_net0 }} --ipconfig0 'ip={{ 'dhcp' if network_mode == 'dhcp' else ansible_host + '/24' }}{% if network_mode == 'static' %},gw={{ network_config.gateway | default('172.16.100.1') }}{% endif %}' --agent 1"
  delegate_to: localhost
  when: not ansible_check_mode
  changed_when: true

- name: Force Disk Resize
  ansible.builtin.shell: |
    ssh -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ proxmox_api_host }} \
    "qm resize {{ vmid }} scsi0 {{ vm_disk_size }}G"
  delegate_to: localhost
  when: not ansible_check_mode
  ignore_errors: yes

- name: Start VM
  community.proxmox.proxmox_kvm:
    api_host: "{{ proxmox_api_host }}"
    api_user: "{{ pve_api_user }}"
    api_token_id: "{{ pve_api_token_id }}"
    api_token_secret: "{{ pve_api_token_secret }}"
    node: "{{ proxmox_node }}"
    vmid: "{{ vmid }}"
    validate_certs: no
    state: started
  delegate_to: localhost
  when: not ansible_check_mode

- name: Final SSH Bootstrap (Force Keys via Agent)
  ansible.builtin.shell: |
    ssh -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ proxmox_api_host }} <<'EOF'
    # Wait for agent to come online
    for i in {1..12}; do
      if qm agent {{ vmid }} ping; then break; fi
      sleep 10
    done

    # Inject keys forcefully
    qm guest exec {{ vmid }} -- mkdir -p /root/.ssh
    qm guest exec {{ vmid }} -- bash -c "echo '{{ global_ssh_keys | join('\n') }}' > /root/.ssh/authorized_keys"
    qm guest exec {{ vmid }} -- chmod 700 /root/.ssh
    qm guest exec {{ vmid }} -- chmod 600 /root/.ssh/authorized_keys
    qm guest exec {{ vmid }} -- sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
    qm guest exec {{ vmid }} -- systemctl restart ssh
    EOF
  delegate_to: localhost
  when: not ansible_check_mode
  changed_when: true

- name: Wait for SSH access to be restored
  ansible.builtin.wait_for:
    host: "{{ ansible_host }}"
    port: 22
    state: started
    timeout: 120
  delegate_to: localhost
  when: not ansible_check_mode

- name: Run health checks
  ansible.builtin.include_role:
    name: health_check
  when:
    - not ansible_check_mode
    - start_vm
    - health_check_enabled

- name: Run post-provisioning
  ansible.builtin.include_role:
    name: post_provision
  when:
    - not ansible_check_mode
    - start_vm
    - post_provisioning_enabled
