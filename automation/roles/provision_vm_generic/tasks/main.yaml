---
# Generic VM Provisioning Role - Main Tasks
# Refactored to use native community.general.proxmox_kvm module

- name: Validate vm_templates is loaded
  ansible.builtin.assert:
    that:
      - vm_templates is defined
      - vm_tshirt_sizes is defined
    fail_msg: |
      Critical error: vm_templates and vm_tshirt_sizes not defined!
      These should be loaded from group_vars/all.yml
    success_msg: "Template registry loaded"

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - os_type is defined
      - os_type in vm_templates
      - tshirt_size is defined
      - tshirt_size in vm_tshirt_sizes
      - vmid is defined
      - proxmox_node is defined
      - inventory_hostname is defined
    fail_msg: "Missing required variables for VM provisioning!"
    success_msg: "All required variables validated"

- name: Set facts from templates, sizes, and network profile
  ansible.builtin.set_fact:
    template_vmid: "{{ vm_templates[os_type].vmid }}"
    vm_default_user: "{{ vm_templates[os_type].default_user }}"
    vm_cores: "{{ vm_tshirt_sizes[tshirt_size].cores }}"
    vm_memory: "{{ vm_tshirt_sizes[tshirt_size].memory }}"
    vm_disk_size: "{{ vm_tshirt_sizes[tshirt_size].disk }}"
    size_description: "{{ vm_tshirt_sizes[tshirt_size].description }}"
    proxmox_api_host: "{{ hostvars[proxmox_node].ansible_host }}"
    vm_storage_backend: "{{ vm_storage | default(proxmox_storage_backends[proxmox_node].vm_storage) }}"
    network_config: "{{ network_profiles[network_profile | default('apps')] }}"

- name: Construct net0 string
  ansible.builtin.set_fact:
    vm_net0: "virtio,bridge={{ network_config.bridge | default('vmbr0') }}{% if network_config.vlan is not none %},tag={{ network_config.vlan }}{% endif %}"

- name: Display provisioning plan
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "VM Provisioning Plan (Native)"
      - "=========================================="
      - "Hostname: {{ inventory_hostname }}"
      - "VMID: {{ vmid }}"
      - "Proxmox Node: {{ proxmox_node }}"
      - "OS: {{ os_type }} ({{ vm_templates[os_type].description }})"
      - "Size: {{ tshirt_size }} ({{ size_description }})"
      - "Network: {{ network_mode }}"
      - "Net0: {{ vm_net0 }}"
      - "Storage: {{ vm_storage_backend }}"
      - "Clone Type: {{ 'Full' if clone_full else 'Linked' }}"
      - "=========================================="

- name: Provision VM using native module (Clone)
  community.general.proxmox_kvm:
    api_host: "{{ proxmox_api_host }}"
    api_user: "{{ pve_api_user }}"
    api_token_id: "{{ pve_api_token_id }}"
    api_token_secret: "{{ pve_api_token_secret }}"
    node: "{{ proxmox_node }}"
    vmid: "{{ vmid }}"
    name: "{{ inventory_hostname }}"
    clone: "{{ template_vmid }}"
    full: "{{ clone_full }}"
    storage: "{{ vm_storage_backend if clone_full else omit }}"
    cores: "{{ vm_cores }}"
    memory: "{{ vm_memory }}"
    net:
      net0: "{{ vm_net0 }}"
    scsis:
      scsi0: "{{ vm_storage_backend }}:{{ vm_disk_size }}"
    ipconfig:
      ipconfig0: "ip={{ 'dhcp' if network_mode == 'dhcp' else ansible_host + '/24' }}{% if network_mode == 'static' %},gw={{ network_config.gateway | default('172.16.100.1') }}{% endif %}"
    sshkeys: "{{ global_ssh_keys | join('\n') }}"
    agent: "{{ 1 if enable_qemu_agent else 0 }}"
    validate_certs: no
    state: "{{ 'started' if start_vm else 'present' }}"
    timeout: "{{ clone_wait_time }}"
  delegate_to: localhost
  register: vm_provision_result

- name: Wait for VM to boot and get IP
  block:
    - name: Wait for VM to be in started state
      community.general.proxmox_kvm:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ pve_api_user }}"
        api_token_id: "{{ pve_api_token_id }}"
        api_token_secret: "{{ pve_api_token_secret }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ vmid }}"
        validate_certs: no
        state: started
      delegate_to: localhost
      register: vm_start_wait
      until: vm_start_wait.status == 'running'
      retries: 10
      delay: 5

    - name: Get VM IP address (DHCP mode)
      ansible.builtin.shell: |
        ssh -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ proxmox_api_host }} \
        "qm agent {{ vmid }} network-get-interfaces | jq -r '.result[] | select(.name==\"eth0\" or .name==\"ens18\") | .[\"ip-addresses\"][] | select(.\"ip-address-type\"==\"ipv4\") | .[\"ip-address\"]' | grep -v '^127'"
      register: discovered_ip
      delegate_to: localhost
      retries: 15
      delay: 10
      until: discovered_ip.stdout != ""
      when: network_mode == 'dhcp'

    - name: Wait for SSH to be ready (static IP mode)
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 22
        delay: 5
        timeout: "{{ ssh_wait_timeout }}"
      delegate_to: localhost
      when: network_mode == 'static'
  when: start_vm

- name: Run health checks
  ansible.builtin.include_role:
    name: health_check
  vars:
    health_check_profile: "{{ hostvars[inventory_hostname].health_check_profile | default('basic') }}"
  when:
    - start_vm
    - health_check_enabled
    - vm_provision_result.changed or skip_existing_check

- name: Run post-provisioning
  ansible.builtin.include_role:
    name: post_provision
  vars:
    post_provisioning_profile: "{{ hostvars[inventory_hostname].post_provisioning_profile | default('none') }}"
  when:
    - start_vm
    - post_provisioning_enabled
    - vm_provision_result.changed or skip_existing_check
