---
- name: "Check if IdM is already installed"
  ansible.builtin.stat:
    path: /etc/ipa/default.conf
  register: idm_default_conf

- name: "Set effective IdM host naming"
  ansible.builtin.set_fact:
    idm_hostname_effective: "{{ idm_hostname | default(inventory_hostname_short) }}"
    idm_fqdn_effective: >-
      {{ idm_fqdn | default((inventory_hostname if ('.' in inventory_hostname) else (idm_hostname_effective ~ '.' ~ idm_domain))) }}

- name: "Validate required IdM variables (primary)"
  ansible.builtin.assert:
    that:
      - idm_admin_password is defined
      - idm_admin_password | length > 0
      - idm_dm_password is defined
      - idm_dm_password | length > 0
      - idm_domain is defined
      - idm_realm is defined
    fail_msg: "Missing required IdM primary vars (idm_admin_password, idm_dm_password, idm_domain, idm_realm)."
  when: idm_role == 'primary' and not idm_default_conf.stat.exists

- name: "Validate required IdM variables (replica)"
  ansible.builtin.assert:
    that:
      - idm_admin_password is defined
      - idm_admin_password | length > 0
      - idm_primary_fqdn is defined
      - idm_primary_fqdn | length > 0
      - idm_domain is defined
      - idm_realm is defined
    fail_msg: "Missing required IdM replica vars (idm_admin_password, idm_primary_fqdn, idm_domain, idm_realm)."
  when: idm_role == 'replica' and not idm_default_conf.stat.exists

- name: "Fetch Red Hat release key 4 (ML-DSA)"
  ansible.builtin.get_url:
    url: "https://security.access.redhat.com/data/6afedf8f.txt"
    dest: /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release4
    mode: "0644"

- name: "Ensure RHEL RPM GPG keys are installed"
  ansible.builtin.rpm_key:
    key: "{{ item }}"
    state: present
  loop:
    - /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
    - /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-beta

- name: "Check if release key 4 is imported"
  ansible.builtin.command:
    cmd: "rpm -qa gpg-pubkey*"
  register: rpm_keys_list
  changed_when: false

- name: "Import Red Hat release key 4 (ML-DSA)"
  ansible.builtin.command:
    cmd: "rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release4"
  when: "'05707a62' not in rpm_keys_list.stdout"

- name: "Build IdM package list"
  ansible.builtin.set_fact:
    idm_packages: "{{ ['ipa-server'] + (idm_setup_dns | bool | ternary(['ipa-server-dns'], [])) }}"

- name: "Install required IdM packages"
  ansible.builtin.package:
    name: "{{ idm_packages }}"
    state: present

- name: "Assemble ipa-server-install arguments"
  ansible.builtin.set_fact:
    idm_install_args: >-
      {{
        [
          'ipa-server-install',
          '--unattended',
          '--realm', idm_realm,
          '--domain', idm_domain,
          '--hostname', idm_fqdn_effective,
          '--ds-password', idm_dm_password,
          '--admin-password', idm_admin_password
        ]
        + (idm_setup_dns | bool | ternary(['--setup-dns'], ['--no-dns']))
        + (
            (idm_setup_dns | bool) | ternary(
              (idm_forwarders | default([]) | map('regex_replace', '^(.*)$', '--forwarder=\\1') | list),
              []
            )
          )
        + (
            (idm_setup_dns | bool and (idm_forwarders | default([]) | length == 0))
            | ternary(['--auto-forwarders'], [])
          )
      }}
  when: idm_role == 'primary' and not idm_default_conf.stat.exists

- name: "Assemble ipa-replica-install arguments"
  ansible.builtin.set_fact:
    idm_replica_install_args: >-
      {{
        [
          'ipa-replica-install',
          '--unattended',
          '--server', idm_primary_fqdn,
          '--realm', idm_realm,
          '--domain', idm_domain,
          '--principal', idm_admin_principal,
          '--admin-password', idm_admin_password,
          '--hostname', idm_fqdn_effective
        ]
        + (idm_setup_dns | bool | ternary(['--setup-dns'], ['--no-dns']))
        + (
            (idm_setup_dns | bool) | ternary(
              (idm_forwarders | default([]) | map('regex_replace', '^(.*)$', '--forwarder=\\1') | list),
              []
            )
          )
        + (
            (idm_setup_dns | bool and (idm_forwarders | default([]) | length == 0))
            | ternary(['--auto-forwarders'], [])
          )
      }}
  when: idm_role == 'replica' and not idm_default_conf.stat.exists

- name: "Install IdM primary server (ipa-server-install)"
  ansible.builtin.command:
    argv: "{{ idm_install_args }}"
  when: idm_role == 'primary' and not idm_default_conf.stat.exists

- name: "Install IdM replica server (ipa-replica-install)"
  ansible.builtin.command:
    argv: "{{ idm_replica_install_args }}"
  when: idm_role == 'replica' and not idm_default_conf.stat.exists
