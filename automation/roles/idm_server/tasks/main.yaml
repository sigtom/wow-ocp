---
- name: "Check if IdM is already installed"
  ansible.builtin.stat:
    path: /etc/ipa/default.conf
  register: idm_default_conf

- name: "Set effective IdM host naming"
  ansible.builtin.set_fact:
    idm_hostname_effective: "{{ idm_hostname | default(inventory_hostname_short) }}"
    idm_fqdn_effective: >-
      {{ idm_fqdn | default((inventory_hostname if ('.' in inventory_hostname) else (idm_hostname_effective ~ '.' ~ idm_domain))) }}

- name: "Determine IdM host IP for /etc/hosts"
  ansible.builtin.set_fact:
    idm_host_ip: "{{ ansible_host | default(ansible_default_ipv4.address) }}"
  when: idm_role == 'primary' and not idm_default_conf.stat.exists

- name: "Remove localhost mapping for IdM hostname"
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^(127\.0\.0\.1|::1)\s+.*\b({{ idm_fqdn_effective | regex_escape }}|{{ idm_hostname_effective | regex_escape }})\b.*$'
    state: absent
  when: idm_role == 'primary' and not idm_default_conf.stat.exists

- name: "Ensure IdM hostname resolves to its IP"
  ansible.builtin.lineinfile:
    path: /etc/hosts
    line: "{{ idm_host_ip }} {{ idm_fqdn_effective }} {{ idm_hostname_effective }}"
    state: present
    create: true
  when: idm_role == 'primary' and not idm_default_conf.stat.exists

- name: "Validate required IdM variables (primary)"
  ansible.builtin.assert:
    that:
      - idm_admin_password is defined
      - idm_admin_password | length > 0
      - idm_dm_password is defined
      - idm_dm_password | length > 0
      - idm_domain is defined
      - idm_realm is defined
    fail_msg: "Missing required IdM primary vars (idm_admin_password, idm_dm_password, idm_domain, idm_realm)."
  when: idm_role == 'primary' and not idm_default_conf.stat.exists

- name: "Validate required IdM variables (replica)"
  ansible.builtin.assert:
    that:
      - idm_admin_password is defined
      - idm_admin_password | length > 0
      - idm_primary_fqdn is defined
      - idm_primary_fqdn | length > 0
      - idm_domain is defined
      - idm_realm is defined
    fail_msg: "Missing required IdM replica vars (idm_admin_password, idm_primary_fqdn, idm_domain, idm_realm)."
  when: idm_role == 'replica' and not idm_default_conf.stat.exists

- name: "Fetch Red Hat release key 4 (ML-DSA)"
  ansible.builtin.get_url:
    url: "https://security.access.redhat.com/data/6afedf8f.txt"
    dest: /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release4
    mode: "0644"

- name: "Ensure RHEL RPM GPG keys are installed"
  ansible.builtin.rpm_key:
    key: "{{ item }}"
    state: present
  loop:
    - /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
    - /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-beta

- name: "Check if release key 4 is imported"
  ansible.builtin.command:
    cmd: "rpm -qa gpg-pubkey*"
  register: rpm_keys_list
  changed_when: false

- name: "Import Red Hat release key 4 (ML-DSA)"
  ansible.builtin.command:
    cmd: "rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release4"
  when: "'05707a62' not in rpm_keys_list.stdout"

- name: "Build IdM package list"
  ansible.builtin.set_fact:
    idm_packages: "{{ ['ipa-server'] + (idm_setup_dns | bool | ternary(['ipa-server-dns'], [])) }}"

- name: "Install required IdM packages"
  ansible.builtin.package:
    name: "{{ idm_packages }}"
    state: present

- name: "Assemble ipa-server-install arguments"
  ansible.builtin.set_fact:
    idm_install_args: >-
      {{
        [
          'ipa-server-install',
          '--unattended',
          '--realm', idm_realm,
          '--domain', idm_domain,
          '--hostname', idm_fqdn_effective,
          '--ds-password', idm_dm_password,
          '--admin-password', idm_admin_password
        ]
        + (idm_setup_dns | bool | ternary(['--setup-dns'], ['--no-dns']))
        + (
            (idm_setup_dns | bool) | ternary(
              (idm_forwarders | default([]) | map('regex_replace', '^', '--forwarder=') | list),
              []
            )
          )
        + (
            (idm_setup_dns | bool and (idm_forwarders | default([]) | length == 0))
            | ternary(['--auto-forwarders'], [])
          )
      }}
  when: idm_role == 'primary' and not idm_default_conf.stat.exists

- name: "Assemble ipa-replica-install arguments"
  ansible.builtin.set_fact:
    idm_replica_install_args: >-
      {{
        [
          'ipa-replica-install',
          '--unattended',
          '--server', idm_primary_fqdn,
          '--realm', idm_realm,
          '--domain', idm_domain,
          '--principal', idm_admin_principal,
          '--admin-password', idm_admin_password,
          '--hostname', idm_fqdn_effective
        ]
        + (idm_setup_dns | bool | ternary(['--setup-dns'], ['--no-dns']))
        + (
            (idm_setup_dns | bool) | ternary(
              (idm_forwarders | default([]) | map('regex_replace', '^', '--forwarder=') | list),
              []
            )
          )
        + (
            (idm_setup_dns | bool and (idm_forwarders | default([]) | length == 0))
            | ternary(['--auto-forwarders'], [])
          )
      }}
  when: idm_role == 'replica' and not idm_default_conf.stat.exists

- name: "Install IdM primary server (ipa-server-install)"
  ansible.builtin.command:
    argv: "{{ idm_install_args }}"
  when: idm_role == 'primary' and not idm_default_conf.stat.exists

- name: "Install IdM replica server (ipa-replica-install)"
  ansible.builtin.command:
    argv: "{{ idm_replica_install_args }}"
  when: idm_role == 'replica' and not idm_default_conf.stat.exists

- name: "Validate Let's Encrypt prerequisites"
  ansible.builtin.assert:
    that:
      - idm_le_email | length > 0
      - idm_le_cloudflare_token | length > 0
    fail_msg: "Set idm_le_email and CF_DNS_API_TOKEN (or CLOUDFLARE_TOKEN) to enable Let's Encrypt issuance."
  when: idm_le_enabled | bool

- name: "Install EPEL release (RHEL)"
  ansible.builtin.dnf:
    name: "https://dl.fedoraproject.org/pub/epel/epel-release-latest-10.noarch.rpm"
    state: present
  when:
    - idm_le_enabled | bool
    - ansible_facts.os_family == 'RedHat'

- name: "Install certbot and Cloudflare DNS plugin"
  ansible.builtin.package:
    name:
      - certbot
      - python3-certbot-dns-cloudflare
    state: present
  when: idm_le_enabled | bool

- name: "Ensure certbot secrets directory exists"
  ansible.builtin.file:
    path: /root/.secrets/certbot
    state: directory
    mode: "0700"
  when: idm_le_enabled | bool

- name: "Write Cloudflare DNS token for certbot"
  ansible.builtin.copy:
    dest: /root/.secrets/certbot/cloudflare.ini
    content: "dns_cloudflare_api_token={{ idm_le_cloudflare_token }}\n"
    mode: "0600"
  when: idm_le_enabled | bool

- name: "Check if Let's Encrypt cert exists"
  ansible.builtin.stat:
    path: "/etc/letsencrypt/live/{{ idm_fqdn_effective }}/fullchain.pem"
  register: idm_le_cert
  when: idm_le_enabled | bool

- name: "Request Let's Encrypt certificate (DNS-01)"
  ansible.builtin.command:
    argv: >-
      {{
        [
          'certbot', 'certonly',
          (idm_le_staging | bool) | ternary('--test-cert', '--server=https://acme-v02.api.letsencrypt.org/directory'),
          '--dns-cloudflare',
          '--dns-cloudflare-credentials', '/root/.secrets/certbot/cloudflare.ini',
          '-d', idm_fqdn_effective,
          '--agree-tos',
          '-m', idm_le_email,
          '--non-interactive'
        ]
        + (idm_le_force_renew | bool | ternary(['--force-renewal'], []))
      }}
  when:
    - idm_le_enabled | bool
    - idm_le_force_renew | bool or not idm_le_cert.stat.exists

- name: "Install Let's Encrypt root CA into IPA trust store"
  ansible.builtin.command:
    argv:
      - ipa-cacert-manage
      - install
      - "{{ idm_le_root_ca_path }}"
  register: idm_le_root_install
  changed_when: "'successfully installed' in (idm_le_root_install.stdout | lower)"
  failed_when: false
  when: idm_le_enabled | bool

- name: "Install Let's Encrypt intermediate chain into IPA trust store"
  ansible.builtin.command:
    argv:
      - ipa-cacert-manage
      - install
      - "/etc/letsencrypt/live/{{ idm_fqdn_effective }}/chain.pem"
  register: idm_le_chain_install
  changed_when: "'successfully installed' in (idm_le_chain_install.stdout | lower)"
  failed_when: false
  when: idm_le_enabled | bool

- name: "Update IPA trust stores"
  ansible.builtin.command:
    argv: [ipa-certupdate]
  when: idm_le_enabled | bool

- name: "Build fullchain with root for IPA"
  ansible.builtin.shell: >-
    cat /etc/letsencrypt/live/{{ idm_fqdn_effective }}/cert.pem
    /etc/letsencrypt/live/{{ idm_fqdn_effective }}/chain.pem
    {{ idm_le_root_ca_path }}
    > /root/ipa/fullchain-with-root.pem
  args:
    executable: /bin/bash
  when: idm_le_enabled | bool

- name: "Ensure IPA cert secret directory exists"
  ansible.builtin.file:
    path: /root/.secrets/ipa
    state: directory
    mode: "0700"
  when: idm_le_enabled | bool

- name: "Store Directory Manager password for renew hook"
  ansible.builtin.copy:
    dest: /root/.secrets/ipa/dirman_password
    content: "{{ idm_dm_password }}\n"
    mode: "0600"
  when: idm_le_enabled | bool

- name: "Install Let's Encrypt certificate for IPA HTTP"
  ansible.builtin.command:
    argv:
      - ipa-server-certinstall
      - -w
      - -d
      - /root/ipa/fullchain-with-root.pem
      - "/etc/letsencrypt/live/{{ idm_fqdn_effective }}/privkey.pem"
      - --dirman-password
      - "{{ idm_dm_password }}"
  args:
    stdin: "\n"
  when: idm_le_enabled | bool

- name: "Install certbot deploy hook for IPA"
  ansible.builtin.copy:
    dest: /etc/letsencrypt/renewal-hooks/deploy/ipa-web.sh
    mode: "0700"
    content: |
      #!/bin/bash
      set -euo pipefail
      DIRMAN_PASSWORD=$(cat /root/.secrets/ipa/dirman_password)
      cat /etc/letsencrypt/live/{{ idm_fqdn_effective }}/cert.pem \
          /etc/letsencrypt/live/{{ idm_fqdn_effective }}/chain.pem \
          {{ idm_le_root_ca_path }} \
          > /root/ipa/fullchain-with-root.pem
      ipa-server-certinstall -w -d /root/ipa/fullchain-with-root.pem \
        /etc/letsencrypt/live/{{ idm_fqdn_effective }}/privkey.pem \
        --dirman-password "$DIRMAN_PASSWORD" <<< ""
      systemctl restart httpd
  when: idm_le_enabled | bool

- name: "Ensure firewalld is installed"
  ansible.builtin.package:
    name: firewalld
    state: present

- name: "Ensure firewalld is running"
  ansible.builtin.service:
    name: firewalld
    state: started
    enabled: true

- name: "Open IdM TCP ports"
  ansible.posix.firewalld:
    port: "{{ item }}/tcp"
    permanent: true
    state: enabled
    immediate: true
  loop:
    - 80
    - 443
    - 389
    - 636
    - 88
    - 464
    - 53

- name: "Open IdM UDP ports"
  ansible.posix.firewalld:
    port: "{{ item }}/udp"
    permanent: true
    state: enabled
    immediate: true
  loop:
    - 88
    - 464
    - 53
    - 123

- name: "Ensure CA backup directory exists"
  ansible.builtin.file:
    path: /root/ipa-certs
    state: directory
    mode: "0700"

- name: "Check if IdM CA bundle exists"
  ansible.builtin.stat:
    path: /root/cacert.p12
  register: idm_cacert

- name: "Backup IdM CA certificate bundle"
  ansible.builtin.copy:
    src: /root/cacert.p12
    dest: /root/ipa-certs/cacert.p12
    remote_src: true
    mode: "0600"
  when: idm_cacert.stat.exists
