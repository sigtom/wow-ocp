---
# Database Profile  
# Installs PostgreSQL in Docker (preferred method)
# Note: For production databases, consider using docker_host + docker-compose

- name: Display database profile notice
  ansible.builtin.debug:
    msg:
      - "⚠️  Database Profile: Docker-based PostgreSQL"
      - ""
      - "This profile prepares the host for running PostgreSQL in Docker."
      - "For full database deployment, use docker_host profile + docker-compose."

- name: Ensure Docker is installed
  block:
    - name: Check if Docker is installed
      ansible.builtin.command: docker --version
      register: docker_check
      changed_when: false
      failed_when: false
    
    - name: Fail if Docker not installed
      ansible.builtin.fail:
        msg: |
          Docker is not installed! 
          
          The database profile requires Docker to be installed first.
          
          Options:
            1. Use post_provisioning_profile: docker_host first
            2. Install Docker manually
            3. Use a dedicated database VM with PostgreSQL installed directly
      when: docker_check.rc != 0
    
    - name: Record Docker verification
      ansible.builtin.set_fact:
        post_provision_tasks_completed: "{{ post_provision_tasks_completed + ['Docker verified for database'] }}"
  rescue:
    - name: Record Docker check failure
      ansible.builtin.set_fact:
        post_provision_tasks_failed: "{{ post_provision_tasks_failed + ['Docker verification failed'] }}"

- name: Create database directories
  block:
    - name: Create PostgreSQL data directory
      ansible.builtin.file:
        path: /opt/postgresql/data
        state: directory
        mode: '0700'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      become: yes
    
    - name: Create PostgreSQL backup directory
      ansible.builtin.file:
        path: /opt/postgresql/backups
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      become: yes
    
    - name: Record directory creation
      ansible.builtin.set_fact:
        post_provision_tasks_completed: "{{ post_provision_tasks_completed + ['PostgreSQL directories created'] }}"
  rescue:
    - name: Record directory creation failure
      ansible.builtin.set_fact:
        post_provision_tasks_failed: "{{ post_provision_tasks_failed + ['Directory creation failed'] }}"

- name: Pull PostgreSQL Docker image
  block:
    - name: Pull PostgreSQL {{ postgresql_version }} image
      ansible.builtin.command: docker pull postgres:{{ postgresql_version }}
      register: postgres_pull
      changed_when: "'Downloaded newer image' in postgres_pull.stdout or 'Pulling from' in postgres_pull.stdout"
    
    - name: Record image pull
      ansible.builtin.set_fact:
        post_provision_tasks_completed: "{{ post_provision_tasks_completed + ['PostgreSQL image pulled'] }}"
  rescue:
    - name: Record image pull failure
      ansible.builtin.set_fact:
        post_provision_tasks_failed: "{{ post_provision_tasks_failed + ['PostgreSQL image pull failed'] }}"

- name: Display database setup info
  ansible.builtin.debug:
    msg:
      - "✅ Database host prepared:"
      - "  Docker verified"
      - "  PostgreSQL {{ postgresql_version }} image pulled"
      - "  Data directories created:"
      - "    - /opt/postgresql/data"
      - "    - /opt/postgresql/backups"
      - ""
      - "Next steps:"
      - "  1. Create docker-compose.yml for PostgreSQL"
      - "  2. Set database password in environment"
      - "  3. Run: docker compose up -d"
      - ""
      - "Example docker-compose.yml:"
      - "  services:"
      - "    postgres:"
      - "      image: postgres:{{ postgresql_version }}"
      - "      volumes:"
      - "        - /opt/postgresql/data:/var/lib/postgresql/data"
      - "      environment:"
      - "        POSTGRES_PASSWORD: ${DB_PASSWORD}"
  when: post_provision_verbose
