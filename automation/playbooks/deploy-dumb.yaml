---
# ============================================================================
# Deploy DUMB (Debrid Unlimited Media Bridge)
# ============================================================================
# Description: Deploy DUMB AIO media stack to an existing Docker LXC
#
# Prerequisites:
#   - LXC container with Docker installed
#   - Secrets synced to AAP from ESO (dumb-secrets, media-arr-secrets)
#
# Variables (Provided by AAP Credentials):
#   - realdebrid_api_key
#   - torbox_api_key
#   - sonarr_api_key
#   - radarr_api_key
# ============================================================================

- name: "Deploy DUMB Media Stack"
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: "Add target to runtime inventory"
      ansible.builtin.add_host:
        name: "{{ target_ip | default('172.16.100.20') }}"
        groups: dumb_targets
        ansible_user: root

- name: "Configure DUMB"
  hosts: dumb_targets
  gather_facts: true
  vars:
    dumb_install_dir: /opt/dumb
  tasks:
    # ========================================
    # Phase 1: Directory Structure
    # ========================================
    - name: "Create DUMB directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "1000"
        group: "1000"
        mode: '0755'
      loop:
        - "{{ dumb_install_dir }}"
        - "{{ dumb_install_dir }}/config"
        - "{{ dumb_install_dir }}/log"
        - "{{ dumb_install_dir }}/data"
        - "{{ dumb_install_dir }}/data/decypharr"
        - "{{ dumb_install_dir }}/cache"
        - "{{ dumb_install_dir }}/cache/decypharr"
        - "{{ dumb_install_dir }}/mnt/debrid"

    # ========================================
    # Phase 2: Deploy Configuration Files
    # ========================================
    - name: "Deploy Decypharr config.json"
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/dumb/decypharr_config.json.j2"
        dest: "{{ dumb_install_dir }}/data/decypharr/config.json"
        owner: "1000"
        group: "1000"
        mode: '0644'
      notify: "Restart DUMB"

    - name: "Deploy Riven settings.json"
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/dumb/riven_settings.json.j2"
        dest: "{{ dumb_install_dir }}/data/riven/settings.json"
        owner: "1000"
        group: "1000"
        mode: '0644'
      notify: "Restart DUMB"

    - name: "Deploy docker-compose.yml"
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../templates/dumb/docker-compose.yml"
        dest: "{{ dumb_install_dir }}/docker-compose.yml"
        mode: '0644'

    - name: "Deploy .env from template"
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/dumb/dumb.env.j2"
        dest: "{{ dumb_install_dir }}/.env"
        mode: '0600'
      notify: "Restart DUMB"

    # ========================================
    # Phase 3: Start Services
    # ========================================
    - name: "Pull DUMB image"
      ansible.builtin.command:
        cmd: docker compose pull
        chdir: "{{ dumb_install_dir }}"
      register: pull_result
      changed_when: "'Pulled' in pull_result.stderr or 'Downloaded' in pull_result.stderr"

    - name: "Start DUMB container"
      ansible.builtin.command:
        cmd: docker compose up -d
        chdir: "{{ dumb_install_dir }}"
      register: compose_up

  handlers:
    - name: "Restart DUMB"
      ansible.builtin.command:
        cmd: docker compose restart dumb
        chdir: "{{ dumb_install_dir }}"
