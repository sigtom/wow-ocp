---
# ============================================================================
# Sync DNS to Pi-hole v6
# ============================================================================
# Description: Sync local DNS records to multiple Pi-hole v6 instances via 
#              the new REST API using Session ID (SID) authentication.
#
# AAP Usage:
#   - Job Template: "Sync DNS to Pi-holes"
#   - Credentials: "Pi-hole API Keys"
# ============================================================================

- name: "Sync Records to Pi-hole v6"
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # Target Traefik IP for all app aliases
    traefik_ip: "172.16.100.10"
    
    # Credentials injected via AAP Environment Variables
    key_116: "{{ lookup('env', 'PIHOLE_KEY_116') }}"
    key_100_2: "{{ lookup('env', 'PIHOLE_KEY_100_2') }}"
    key_110_100: "{{ lookup('env', 'PIHOLE_KEY_110_100') }}"

    # Pi-hole Instances
    piholes:
      # - { name: "Pihole-116", url: "https://10.0.0.116/api", token: "{{ key_116 }}" } # Pending network upgrade
      - { name: "Pihole-100-2", url: "https://172.16.100.2/api", token: "{{ key_100_2 }}" }
      - { name: "Pihole-110-100", url: "http://172.16.110.100:20720/api", token: "{{ key_110_100 }}" }

    # Records to sync
    dns_records:
      - "sabnzbd.sigtom.io"
      - "qb.sigtom.io"
      - "overseerr.sigtom.io"
      - "dumb.sigtom.io"
      - "riven.sigtom.io"
      - "sonarr.sigtom.io"
      - "radarr.sigtom.io"
      - "prowlarr.sigtom.io"
      - "traefik.sigtom.io"

  tasks:
    - name: "Process each Pi-hole instance"
      ansible.builtin.include_tasks:
        file: "{{ playbook_dir }}/sync-single-pihole.yml"
      loop: "{{ piholes }}"
      loop_control:
        loop_var: pihole
      no_log: true
