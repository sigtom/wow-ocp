---
# Proxmox VM Deployment Playbook - wow-ubu-test
# Dev work VM with DHCP networking

- name: Deploy Proxmox VM from Template with DHCP
  hosts: localhost
  gather_facts: no
  vars:
    vm_name: wow-ubu-test
    vm_vmid: 212
    vm_cores: 2
    vm_memory: 2048
    vm_disk_size: 50
    proxmox_node: wow-prox1
    proxmox_api_host: 172.16.110.101
    template_vmid: 9024
    pve_api_user: sre-bot@pve
    pve_api_token_id: sre-token
    pve_api_token_secret: "{{ lookup('env', 'PROXMOX_SRE_BOT_API_TOKEN') }}"

  tasks:
    - name: Check if API token is set
      fail:
        msg: "PROXMOX_SRE_BOT_API_TOKEN environment variable not set"
      when: pve_api_token_secret == ""

    - name: Check if VM already exists
      ansible.builtin.uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/qemu/{{ vm_vmid }}/status/current"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ pve_api_user }}!{{ pve_api_token_id }}={{ pve_api_token_secret }}"
        validate_certs: no
        status_code: [200, 404, 500]
      register: vm_check

    - name: Clone VM from template
      ansible.builtin.uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/qemu/{{ template_vmid }}/clone"
        method: POST
        headers:
          Authorization: "PVEAPIToken={{ pve_api_user }}!{{ pve_api_token_id }}={{ pve_api_token_secret }}"
        body_format: form-urlencoded
        body:
          newid: "{{ vm_vmid }}"
          name: "{{ vm_name }}"
          full: 1  # Full clone for independent disk
        validate_certs: no
        status_code: 200
      when: vm_check.status != 200
      register: clone_job

    - name: Wait for clone to finish
      ansible.builtin.pause:
        seconds: 15
      when: vm_check.status != 200

    - name: Configure VM resources and DHCP networking
      ansible.builtin.shell: |
        ssh -o BatchMode=yes -o StrictHostKeyChecking=no -i ~/.ssh/id_pfsense_sre root@{{ proxmox_api_host }} << 'REMOTE'
        # Set CPU and memory
        qm set {{ vm_vmid }} --cores {{ vm_cores }}
        qm set {{ vm_vmid }} --memory {{ vm_memory }}
        
        # Resize disk to {{ vm_disk_size }}GB
        qm resize {{ vm_vmid }} scsi0 {{ vm_disk_size }}G
        
        # Configure DHCP networking (remove any static IP config)
        qm set {{ vm_vmid }} --ipconfig0 "ip=dhcp"
        
        # Add SSH keys
        cat > /tmp/keys_{{ vm_vmid }}.pub << 'KEYS'
        ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEEJZzVG6rJ1TLR0LD2Rf1F/Wd6LdSEa9FoEvcdTqDRd sigtom@ilum
        ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINBfE00YAZ+vxTpzLc5dR1CeqeQqM7VFWYHFWMnLXdUK sigtom@DEFIANT
        KEYS
        qm set {{ vm_vmid }} --sshkeys /tmp/keys_{{ vm_vmid }}.pub
        rm /tmp/keys_{{ vm_vmid }}.pub
        REMOTE
      delegate_to: localhost
      when: vm_check.status != 200

    - name: Start VM
      ansible.builtin.uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/qemu/{{ vm_vmid }}/status/start"
        method: POST
        headers:
          Authorization: "PVEAPIToken={{ pve_api_user }}!{{ pve_api_token_id }}={{ pve_api_token_secret }}"
        validate_certs: no
        status_code: 200
      delegate_to: localhost

    - name: Wait for VM to boot and cloud-init to complete
      ansible.builtin.pause:
        seconds: 30

    - name: Get VM IP address via QEMU guest agent
      ansible.builtin.shell: |
        ssh -o BatchMode=yes -o StrictHostKeyChecking=no -i ~/.ssh/id_pfsense_sre root@{{ proxmox_api_host }} \
        "qm agent {{ vm_vmid }} network-get-interfaces | jq -r '.result[] | select(.name==\"ens18\") | .[\"ip-addresses\"][] | select(.\"ip-address-type\"==\"ipv4\") | .[\"ip-address\"]' | grep -v '^127'"
      register: vm_ip
      delegate_to: localhost
      retries: 10
      delay: 10
      until: vm_ip.stdout != ""

    - name: Display VM information
      debug:
        msg: |
          ========================================
          VM Created Successfully!
          ========================================
          Name: {{ vm_name }}
          VMID: {{ vm_vmid }}
          IP Address: {{ vm_ip.stdout }}
          CPU: {{ vm_cores }} cores
          Memory: {{ vm_memory }}MB
          Disk: {{ vm_disk_size }}GB
          
          Update inventory file with IP:
          sed -i 's/ansible_host: 172.16.110.212/ansible_host: {{ vm_ip.stdout }}/' automation/inventory/hosts.yaml
          
          Access VM:
          ssh -i ~/.ssh/id_pfsense_sre ubuntu@{{ vm_ip.stdout }}
          ========================================
