---
# ============================================================================
# Traefik v3.6 Fully Automated Deployment (Split-Play Architecture)
# ============================================================================
# Description: Deploy Traefik reverse proxy with complete automation
# Target: Proxmox LXC container with Docker
# 
# Architecture: Split into 2 plays to isolate fact namespaces
#   Play 1: Provision infrastructure (runs on localhost, creates LXC)
#   Play 2: Configure services (runs on container, installs Docker + Traefik)
# 
# This prevents Ansible fact caching bug where localhost facts (Fedora)
# bleed into container fact gathering (Ubuntu), causing Docker install to fail.
#
# What this playbook does:
#   1. Provision LXC container (210 @ 172.16.100.10)
#   2. Install Docker + Docker Compose
#   3. Copy all Traefik configuration files
#   4. Deploy Traefik stack with DNS-01 challenge (NO port forwarding needed)
#   5. Verify Traefik is running
#   6. Check certificate acquisition (all 7 wildcard domains)
#   7. Deploy whoami test containers for all 7 domains
#   8. Verify end-to-end SSL/TLS
#
# Prerequisites:
#   - Cloudflare API token set in environment: CF_DNS_API_TOKEN
#   - DNS wildcard records for all 7 domains pointing to 172.16.100.10
#     *.nixsysadmin.io ‚Üí 172.16.100.10
#     *.sigtom.com ‚Üí 172.16.100.10
#     *.sigtom.dev ‚Üí 172.16.100.10
#     *.sigtom.info ‚Üí 172.16.100.10
#     *.sigtom.io ‚Üí 172.16.100.10
#     *.sigtomtech.com ‚Üí 172.16.100.10
#     *.tecnixsystems.com ‚Üí 172.16.100.10
#   - NO pfSense port forwarding required (DNS-01 challenge)
#
# Usage:
#   export CF_DNS_API_TOKEN="your-cloudflare-token-here"
#   ansible-playbook -i inventory/hosts.yaml playbooks/deploy-traefik.yaml
#
# ============================================================================

# ============================================================================
# PLAY 1: Provision Infrastructure (Localhost Context)
# ============================================================================

- name: "PLAY 1: Provision Traefik LXC Container"
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    target_node: "{{ proxmox_node | default('wow-prox1') }}"
    target_vmid: "{{ vmid }}"
    target_ip: "{{ ansible_host }}"
    target_hostname: "traefik.sigtom.dev"
    
    resource_size: "{{ lxc_size }}"
    os_template: "{{ lxc_template }}"
    network: "{{ network_profile }}"
    backup_policy: "{{ snapshot_policy | default('default') }}"
    
    # Cloudflare token (from environment variable)
    cloudflare_api_token: "{{ lookup('env', 'CF_DNS_API_TOKEN') }}"

  pre_tasks:
    - name: "Verify Cloudflare API token is set"
      ansible.builtin.fail:
        msg: |
          ‚ùå Cloudflare API token not found!
          
          Please set environment variable:
          export CF_DNS_API_TOKEN="your-cloudflare-token-here"
          
          Create token at: https://dash.cloudflare.com/profile/api-tokens
          Permissions: Zone > DNS > Edit (for ALL 7 domains)
      when: cloudflare_api_token == ""
      delegate_to: localhost

    - name: "Display deployment summary"
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Traefik v3.6 Full Automated Deployment"
          - "=========================================="
          - "Target Node: {{ target_node }}"
          - "Container ID: {{ target_vmid }}"
          - "IP Address: {{ target_ip }}"
          - "Hostname: {{ target_hostname }}"
          - "=========================================="
          - "Managed Domains (7):"
          - "  - *.nixsysadmin.io"
          - "  - *.sigtom.com"
          - "  - *.sigtom.dev"
          - "  - *.sigtom.info"
          - "  - *.sigtom.io"
          - "  - *.sigtomtech.com"
          - "  - *.tecnixsystems.com"
          - "=========================================="
          - "Certificate Method: DNS-01 via Cloudflare"
          - "Port Forwarding: NOT REQUIRED"
          - "=========================================="

  tasks:
    - name: "Gather facts from localhost for timestamp generation"
      ansible.builtin.setup:
        gather_subset:
          - 'date_time'
      delegate_to: localhost
      run_once: true
    
    - name: "Pre-provisioning snapshot"
      ansible.builtin.include_role:
        name: snapshot_manager
      vars:
        snapshot_operation: create
        snapshot_type: pre-provision
        resource_type: lxc
        pve_api_user: "{{ lookup('vars', 'pve_api_user', default='sre-bot@pve') }}"
        pve_api_token_id: "{{ lookup('vars', 'pve_api_token_id', default='sre-token') }}"
        pve_api_token_secret: "{{ lookup('env', 'PROXMOX_SRE_BOT_API_TOKEN') }}"
        proxmox_api_defaults: "{{ lookup('vars', 'proxmox_api_defaults', default={}) }}"
      when: backup_policy != 'none'

    - name: "Provision LXC container"
      ansible.builtin.include_role:
        name: provision_lxc_generic
      vars:
        os_type: "{{ os_template }}"
        tshirt_size: "{{ resource_size }}"
        lxc_features: "nesting=1"
        health_check_enabled: false  # Will do full health check in Play 2
        post_provisioning_enabled: false  # Will do Docker install in Play 2
        skip_existing_check: true  # Allow running on existing container for this deployment

    - name: "Wait for container to be fully booted"
      ansible.builtin.wait_for:
        host: "{{ target_ip }}"
        port: 22
        delay: 10
        timeout: 120
        msg: "SSH not available after 120 seconds"
      delegate_to: localhost

    - name: "Clear any cached known_hosts entries"
      ansible.builtin.shell: |
        ssh-keygen -R {{ target_ip }} 2>/dev/null || true
        ssh-keygen -R {{ target_hostname }} 2>/dev/null || true
      delegate_to: localhost
      changed_when: false
      failed_when: false

    - name: "Add container to known_hosts"
      ansible.builtin.shell: |
        ssh-keyscan -H {{ target_ip }} >> ~/.ssh/known_hosts 2>/dev/null
      delegate_to: localhost
      changed_when: false
      failed_when: false

    - name: "Display Play 1 completion"
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "‚úÖ Play 1 Complete: Infrastructure Provisioned"
          - "=========================================="
          - "Container Status: Created and Running"
          - "IP Address: {{ target_ip }}"
          - "SSH Port: 22 (verified accessible)"
          - ""
          - "Next: Play 2 will configure services..."
          - "=========================================="

    - name: "Add new container to runtime inventory"
      ansible.builtin.add_host:
        name: "{{ target_ip }}"
        groups: traefik
        ansible_user: root
        # SSH connection details are handled by AAP credential injection (ssh-agent)


# ============================================================================
# PLAY 2: Configure Services (Container Context)
# ============================================================================

- name: "PLAY 2: Configure Traefik Services"
  hosts: traefik
  gather_facts: true  # Fresh fact gathering in container context ONLY
  
  vars:
    target_ip: "{{ ansible_host }}"
    target_hostname: "traefik.sigtom.dev"
    backup_policy: "{{ snapshot_policy | default('default') }}"
    
    # Traefik deployment paths
    traefik_base_dir: "/opt/traefik"
    traefik_config_dir: "{{ traefik_base_dir }}/config"
    traefik_certs_dir: "{{ traefik_base_dir }}/letsencrypt"
    traefik_logs_dir: "{{ traefik_base_dir }}/logs"
    
    # Cloudflare token (from environment variable)
    cloudflare_api_token: "{{ lookup('env', 'CF_DNS_API_TOKEN') }}"
    
    # Test domains for whoami containers
    test_domains:
      - "whoami.nixsysadmin.io"
      - "whoami.sigtom.com"
      - "whoami.sigtom.dev"
      - "whoami.sigtom.info"
      - "whoami.sigtom.io"
      - "whoami.sigtomtech.com"
      - "whoami.tecnixsystems.com"

  tasks:
    # ========================================
    # Phase 1: Install Docker
    # ========================================
    
    - name: "Phase 1: Display detected OS info"
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Container OS Detection"
          - "=========================================="
          - "Distribution: {{ ansible_facts['distribution'] }}"
          - "Version: {{ ansible_facts['distribution_version'] }}"
          - "OS Family: {{ ansible_facts['os_family'] }}"
          - "Architecture: {{ ansible_facts['architecture'] }}"
          - "=========================================="

    - name: "Phase 1: Basic health checks"
      ansible.builtin.include_role:
        name: health_check
      vars:
        health_check_profile: basic

    - name: "Phase 1: Install Docker"
      ansible.builtin.include_role:
        name: post_provision
      vars:
        post_provision_profile: docker_host

    - name: "Phase 1: Docker health checks"
      ansible.builtin.include_role:
        name: health_check
      vars:
        health_check_profile: docker

    # ========================================
    # Phase 2: Deploy Traefik Configuration
    # ========================================
    
    - name: "Phase 2: Create Traefik directory structure"
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ traefik_base_dir }}"
        - "{{ traefik_config_dir }}"
        - "{{ traefik_certs_dir }}"
        - "{{ traefik_logs_dir }}"

    - name: "Phase 2: Copy Docker Compose file"
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../templates/traefik/docker-compose.yml"
        dest: "{{ traefik_base_dir }}/docker-compose.yml"
        mode: '0644'

    - name: "Phase 2: Copy Traefik static configuration"
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../templates/traefik/traefik.yml"
        dest: "{{ traefik_base_dir }}/traefik.yml"
        mode: '0644'

    - name: "Phase 2: Install htpasswd on container for auth generation"
      ansible.builtin.apt:
        name: apache2-utils
        state: present
        update_cache: false
      become: yes

    - name: "Phase 2: Generate BasicAuth password"
      ansible.builtin.shell: |
        htpasswd -nbB admin "{{ lookup('password', '/tmp/traefik_admin_pass chars=ascii_letters,digits length=16') }}" | sed 's/\$/\$\$/g'
      register: basicauth_hash
      changed_when: false

    - name: "Phase 2: Create .env file with credentials"
      ansible.builtin.copy:
        dest: "{{ traefik_base_dir }}/.env"
        mode: '0600'
        content: |
          # Traefik Environment Variables (Auto-generated)
          # Generated: {{ ansible_date_time.iso8601 }}
          
          # Cloudflare API Token for DNS-01 challenge
          CF_DNS_API_TOKEN={{ cloudflare_api_token }}
          
          # Traefik Dashboard BasicAuth
          # Username: admin
          # Password: {{ lookup('password', '/tmp/traefik_admin_pass chars=ascii_letters,digits length=16') }}
          TRAEFIK_DASHBOARD_AUTH={{ basicauth_hash.stdout }}
          
          # Timezone
          TZ=America/New_York

    - name: "Phase 2: Save admin credentials to local file"
      ansible.builtin.copy:
        dest: "{{ playbook_dir }}/../.traefik-credentials"
        mode: '0600'
        content: |
          Traefik Dashboard Credentials
          ==============================
          URL: https://traefik.sigtom.dev
          Username: admin
          Password: {{ lookup('password', '/tmp/traefik_admin_pass chars=ascii_letters,digits length=16') }}
          
          Generated: {{ ansible_date_time.iso8601 }}
      delegate_to: localhost

    - name: "Phase 2: Create acme.json with correct permissions"
      ansible.builtin.file:
        path: "{{ traefik_certs_dir }}/acme.json"
        state: touch
        mode: '0600'

    - name: "Phase 2: Install Python Docker library for Ansible"
      ansible.builtin.apt:
        name:
          - python3-docker
          - python3-requests
        state: present
        update_cache: false
      become: yes

    - name: "Phase 2: Remove existing traefik-proxy network if exists (cleanup)"
      ansible.builtin.shell: docker network rm traefik-proxy 2>/dev/null || true
      changed_when: false

    # ========================================
    # Phase 3: Start Traefik and Verify
    # ========================================
    
    - name: "Phase 3: Start Traefik container"
      community.docker.docker_compose_v2:
        project_src: "{{ traefik_base_dir }}"
        state: present
      register: traefik_deploy

    - name: "Phase 3: Wait for Traefik to be healthy"
      ansible.builtin.wait_for:
        host: "{{ target_ip }}"
        port: 443
        delay: 5
        timeout: 60
        msg: "Traefik HTTPS port not available after 60 seconds"

    - name: "Phase 3: Check Traefik container status"
      community.docker.docker_container_info:
        name: traefik
      register: traefik_container
      failed_when: traefik_container.container.State.Status != "running"

    - name: "Phase 3: Wait for certificate acquisition (2 minutes)"
      ansible.builtin.pause:
        seconds: 120
        prompt: "Waiting for Traefik to request Let's Encrypt wildcard certificates via DNS-01..."

    - name: "Phase 3: Verify certificates were issued"
      ansible.builtin.shell: |
        if [ ! -f {{ traefik_certs_dir }}/acme.json ]; then
          echo "ERROR: acme.json not found"
          exit 1
        fi
        
        # Check if acme.json has content
        if [ ! -s {{ traefik_certs_dir }}/acme.json ]; then
          echo "WARNING: acme.json is empty"
          docker logs traefik | tail -50
          exit 1
        fi
        
        # Count certificates (expecting 7 wildcard certs)
        cert_count=$(jq -r '.cloudflare.Certificates // [] | length' {{ traefik_certs_dir }}/acme.json 2>/dev/null || echo "0")
        
        if [ "$cert_count" -lt 7 ]; then
          echo "WARNING: Only $cert_count certificates found (expected 7)"
          echo "Certificate domains:"
          jq -r '.cloudflare.Certificates[]?.domain.main // "unknown"' {{ traefik_certs_dir }}/acme.json 2>/dev/null || echo "Failed to parse domains"
          exit 1
        fi
        
        echo "SUCCESS: $cert_count wildcard certificates acquired"
        jq -r '.cloudflare.Certificates[]?.domain.main' {{ traefik_certs_dir }}/acme.json
      register: cert_check
      changed_when: false
      failed_when: false

    - name: "Phase 3: Display certificate status"
      ansible.builtin.debug:
        msg: "{{ cert_check.stdout_lines }}"

    - name: "Phase 3: Check Traefik logs for errors"
      ansible.builtin.shell: |
        docker logs traefik 2>&1 | grep -i error | tail -20 || echo "No errors found in Traefik logs"
      register: traefik_errors
      changed_when: false

    - name: "Phase 3: Display any errors found"
      ansible.builtin.debug:
        msg: "{{ traefik_errors.stdout_lines }}"
      when: "'No errors found' not in traefik_errors.stdout"

    # ========================================
    # Phase 4: Deploy Test Containers (All 7 Domains)
    # ========================================
    
    - name: "Phase 4: Create whoami test compose file for all domains"
      ansible.builtin.copy:
        dest: "{{ traefik_base_dir }}/whoami-compose.yml"
        mode: '0644'
        content: |
          services:
          {% for domain in test_domains %}
            whoami-{{ loop.index }}:
              image: traefik/whoami:latest
              container_name: whoami-{{ domain.replace('.', '-') }}
              restart: unless-stopped
              networks:
                - traefik-proxy
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.whoami-{{ loop.index }}.rule=Host(`{{ domain }}`)"
                - "traefik.http.routers.whoami-{{ loop.index }}.entrypoints=websecure"
                - "traefik.http.routers.whoami-{{ loop.index }}.tls.certresolver=cloudflare"
                - "traefik.http.services.whoami-{{ loop.index }}.loadbalancer.server.port=80"
          {% endfor %}
          
          networks:
            traefik-proxy:
              external: true

    - name: "Phase 4: Deploy whoami test containers"
      community.docker.docker_compose_v2:
        project_src: "{{ traefik_base_dir }}"
        files:
          - whoami-compose.yml
        state: present

    - name: "Phase 4: Wait for whoami containers to be ready"
      ansible.builtin.pause:
        seconds: 10

    - name: "Phase 4: Verify all test domains are accessible"
      ansible.builtin.uri:
        url: "https://{{ item }}"
        method: GET
        validate_certs: false
        return_content: true
        status_code: 200
      register: whoami_tests
      loop: "{{ test_domains }}"
      retries: 3
      delay: 5
      failed_when: false

    - name: "Phase 4: Display test results"
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Whoami Test Results ({{ test_domains | length }} domains)"
          - "=========================================="
          - "{% for result in whoami_tests.results %}{{ test_domains[loop.index0] }}: {{ 'PASS ‚úÖ' if result.status == 200 else 'FAIL ‚ùå (HTTP ' + (result.status|string) + ')' }}\n{% endfor %}"
          - "=========================================="

    # ========================================
    # Phase 5: Post-Deployment Snapshot
    # ========================================
    
    - name: "Phase 5: Post-provisioning snapshot"
      ansible.builtin.include_role:
        name: snapshot_manager
      vars:
        snapshot_operation: create
        snapshot_type: post-provision
        resource_type: lxc
        pve_api_user: "{{ lookup('vars', 'pve_api_user', default='sre-bot@pve') }}"
        pve_api_token_id: "{{ lookup('vars', 'pve_api_token_id', default='sre-token') }}"
        pve_api_token_secret: "{{ lookup('env', 'PROXMOX_SRE_BOT_API_TOKEN') }}"
        proxmox_api_defaults: "{{ lookup('vars', 'proxmox_api_defaults', default={}) }}"
      when: backup_policy in ['standard', 'production']

    # ========================================
    # Final Summary
    # ========================================
    
    - name: "Deployment Complete - Summary"
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "‚úÖ Traefik v3.6 Deployment Complete!"
          - "=========================================="
          - ""
          - "üìä Status:"
          - "  - LXC Container: {{ traefik_container.container.State.Status }}"
          - "  - Traefik Version: {{ traefik_container.container.Config.Image }}"
          - "  - Certificates: {{ cert_check.stdout_lines[0] if cert_check.rc == 0 else 'Check failed - review logs above' }}"
          - "  - Test Domains: {{ (whoami_tests.results | selectattr('status', 'equalto', 200) | list | length) }}/{{ test_domains | length }} passed"
          - ""
          - "üåê Access Points:"
          - "  - Dashboard: https://traefik.sigtom.dev"
          - "  - Test Domains:"
          - "{% for domain in test_domains %}    - https://{{ domain }}{% endfor %}"
          - ""
          - "üîë Credentials:"
          - "  - Saved to: automation/.traefik-credentials"
          - "  - Username: admin"
          - ""
          - "üìÅ Configuration:"
          - "  - Base Directory: {{ traefik_base_dir }}"
          - "  - Certificates: {{ traefik_certs_dir }}/acme.json"
          - "  - Logs: {{ traefik_logs_dir }}/"
          - ""
          - "üîç Verification Commands:"
          - "  - Check status: ssh root@{{ target_ip }} 'cd {{ traefik_base_dir }} && docker compose ps'"
          - "  - View logs: ssh root@{{ target_ip }} 'docker logs -f traefik'"
          - "  - Check certs: ssh root@{{ target_ip }} 'cat {{ traefik_certs_dir }}/acme.json | jq .'"
          - "  - List domains: ssh root@{{ target_ip }} 'cat {{ traefik_certs_dir }}/acme.json | jq -r \".cloudflare.Certificates[].domain.main\"'"
          - ""
          - "‚úÖ Next Steps:"
          - "  1. Verify dashboard access at https://traefik.sigtom.dev"
          - "  2. Verify all 7 whoami test domains"
          - "  3. Deploy Nautobot behind Traefik"
          - "  4. Migrate other services from OpenShift to Traefik"
          - "=========================================="

  post_tasks:
    - name: "Save deployment summary to file"
      ansible.builtin.copy:
        dest: "{{ playbook_dir }}/../.traefik-deployment-summary.txt"
        content: |
          Traefik v3.6 Deployment Summary
          ================================
          Deployed: {{ ansible_date_time.iso8601 }}
          
          Infrastructure:
            - LXC CTID: {{ vmid }}
            - IP Address: {{ target_ip }}
            - Hostname: {{ target_hostname }}
          
          Access:
            - Dashboard: https://traefik.sigtom.dev
            - Credentials: See automation/.traefik-credentials
          
          Managed Domains (7 wildcard certificates):
            - *.nixsysadmin.io
            - *.sigtom.com
            - *.sigtom.dev
            - *.sigtom.info
            - *.sigtom.io
            - *.sigtomtech.com
            - *.tecnixsystems.com
          
          Test Domains (whoami containers):
          {% for domain in test_domains %}  - https://{{ domain }}
          {% endfor %}
          
          Certificate Method: DNS-01 via Cloudflare (no port forwarding required)
          
          Status: {{ 'SUCCESS - All certificates acquired' if cert_check.rc == 0 else 'PARTIAL - Check logs' }}
          Test Results: {{ (whoami_tests.results | selectattr('status', 'equalto', 200) | list | length) }}/{{ test_domains | length }} domains accessible
      delegate_to: localhost
