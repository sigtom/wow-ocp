---
# ============================================================================
# Setup Docker Swarm Cluster
# ============================================================================
# Description: Initialize a Docker Swarm cluster across LXCs.
#              This enables Traefik auto-discovery via the Swarm API.
#
# Nodes:
#   - Manager: 172.16.100.10 (Traefik)
#   - Workers: 172.16.100.20 (DUMB), 172.16.100.21 (Downloaders)
# ============================================================================

- name: "Initialize Swarm Manager"
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    manager_ip: "172.16.100.10"
    worker_ips:
      - "172.16.100.20"
      - "172.16.100.21"
    # Added for surgical injection
    proxmox_host: "172.16.110.101"
    vmid_map:
      "172.16.100.10": 210
      "172.16.100.20": 220
      "172.16.100.21": 221
    global_ssh_keys:
      - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKfMMLr0UIUkpVUghSd4FkVUteUzFOCP1WknScNOrl8u sigtom@localhost.localdomain"
      - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILPyc7oAxzmaymnrZWblYRbTH/hOd+OPaQStsMNi/3bU sigtom@localhost.localdomain"
      - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEEJZzVG6rJ1TLR0LD2Rf1F/Wd6LdSEa9FoEvcdTqDRd sigtom@ilum"

  tasks:
    - name: "Surgical SSH Key Injection (Force AAP Access)"
      ansible.builtin.shell: |
        ssh -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ proxmox_host }} \
        "pct exec {{ vmid_map[item] }} -- bash -c 'mkdir -p /root/.ssh && chmod 700 /root/.ssh && echo \"{{ key }}\" >> /root/.ssh/authorized_keys && sort -u /root/.ssh/authorized_keys -o /root/.ssh/authorized_keys && chmod 600 /root/.ssh/authorized_keys'"
      loop: "{{ [manager_ip] + worker_ips }}"
      vars:
        key: "{{ global_ssh_keys | first }}" # Inject at least the primary key
      delegate_to: localhost
      changed_when: true

    - name: "Check if Swarm is already initialized on Manager"
      ansible.builtin.shell: |
        ssh -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ manager_ip }} "docker info --format '{{ '{{' }}.Swarm.LocalNodeState{{ '}}' }}'"
      register: swarm_status
      changed_when: false

    - name: "Initialize Swarm"
      ansible.builtin.shell: |
        ssh -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ manager_ip }} "docker swarm init --advertise-addr {{ manager_ip }}"
      when: swarm_status.stdout != 'active'

    - name: "Capture Worker Join Token"
      ansible.builtin.shell: |
        ssh -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ manager_ip }} "docker swarm join-token worker -q"
      register: worker_token
      changed_when: false

    - name: "Join Workers to Swarm"
      ansible.builtin.shell: |
        ssh -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ item }} "docker info --format '{{ '{{' }}.Swarm.LocalNodeState{{ '}}' }}'"
      register: worker_status
      loop: "{{ worker_ips }}"
      changed_when: false

    - name: "Execute Join on Workers"
      ansible.builtin.shell: |
        ssh -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ item.item }} "docker swarm join --token {{ worker_token.stdout }} {{ manager_ip }}:2377"
      loop: "{{ worker_status.results }}"
      when: item.stdout != 'active'

    - name: "Verify Cluster State"
      ansible.builtin.shell: |
        ssh -o BatchMode=yes -o StrictHostKeyChecking=no root@{{ manager_ip }} "docker node ls"
      register: cluster_nodes
      changed_when: false

    - name: "âœ… Swarm Status"
      ansible.builtin.debug:
        msg: "{{ cluster_nodes.stdout_lines }}"
