---
# ============================================================================
# Nautobot IPAM/DCIM Deployment Playbook
# ============================================================================
# Description: Deploy Nautobot using cattle automation framework
# Target: Proxmox LXC container with Docker
# Profile: medium (2C/2GB/20GB), ubuntu24, docker_host
#
# Usage:
#   ansible-playbook -i inventory/hosts.yaml playbooks/deploy-nautobot.yaml
#
# ============================================================================

- name: "Deploy Nautobot IPAM/DCIM Server"
  hosts: nautobot
  gather_facts: false
  
  vars:
    # Deployment target
    target_node: "{{ proxmox_node }}"
    target_vmid: "{{ vmid }}"
    target_ip: "{{ ansible_host }}"
    target_hostname: "ipmgmt.sigtom.dev"
    
    # Resource allocation (from inventory)
    resource_size: "{{ lxc_size }}"
    os_template: "{{ lxc_template }}"
    
    # Networking (from inventory)
    network: "{{ network_profile }}"
    
    # Post-provisioning
    enable_post_provision: "{{ post_provisioning_enabled }}"
    provision_profile: "{{ post_provisioning_profile }}"
    
    # Backup/snapshot
    backup_policy: "{{ snapshot_policy }}"

  tasks:
    - name: "Display deployment summary"
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Nautobot Deployment Configuration"
          - "=========================================="
          - "Target Node: {{ target_node }}"
          - "Container ID: {{ target_vmid }}"
          - "IP Address: {{ target_ip }}"
          - "Hostname: {{ target_hostname }}"
          - "Size Profile: {{ resource_size }}"
          - "OS Template: {{ os_template }}"
          - "Network Profile: {{ network }}"
          - "Post-Provision: {{ provision_profile if enable_post_provision else 'disabled' }}"
          - "Snapshot Policy: {{ backup_policy }}"
          - "=========================================="

    - name: "Pre-provisioning snapshot (if enabled)"
      ansible.builtin.include_role:
        name: snapshot_manager
      vars:
        snapshot_operation: create
        snapshot_type: pre-provision
        resource_type: lxc
      when: backup_policy != 'none'

    - name: "Provision Nautobot LXC container"
      ansible.builtin.include_role:
        name: provision_lxc_generic

    - name: "Wait for container to be ready"
      ansible.builtin.wait_for:
        host: "{{ target_ip }}"
        port: 22
        delay: 5
        timeout: 120
        msg: "SSH not available after 120 seconds"

    - name: "Run health checks"
      ansible.builtin.include_role:
        name: health_check
      vars:
        health_check_profile: basic

    - name: "Post-provisioning configuration (Docker setup)"
      ansible.builtin.include_role:
        name: post_provision
      vars:
        post_provision_profile: "{{ provision_profile }}"
      when: enable_post_provision | bool

    - name: "Re-run health checks (Docker profile)"
      ansible.builtin.include_role:
        name: health_check
      vars:
        health_check_profile: docker
      when: enable_post_provision | bool

    - name: "Post-provisioning snapshot (if enabled)"
      ansible.builtin.include_role:
        name: snapshot_manager
      vars:
        snapshot_operation: create
        snapshot_type: post-provision
        resource_type: lxc
      when: backup_policy in ['standard', 'production']

    - name: "Deployment complete"
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "âœ… Nautobot LXC Deployment Complete!"
          - "=========================================="
          - "Next Steps:"
          - "1. SSH to container: ssh root@{{ target_ip }}"
          - "2. Review Docker setup: docker --version && docker compose version"
          - "3. Deploy Nautobot stack with Docker Compose"
          - "4. Access Nautobot at: https://{{ target_hostname }}"
          - "=========================================="
          - ""
          - "ðŸ“š Documentation:"
          - "  - Nautobot docs: https://docs.nautobot.com/"
          - "  - Docker deployment: https://docs.nautobot.com/projects/core/en/stable/user-guide/administration/installation/docker/"
          - "=========================================="
