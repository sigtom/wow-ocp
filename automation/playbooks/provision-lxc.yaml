---
# ============================================================================
# Provision LXC Container (Generic)
# ============================================================================
# Description: Create an LXC container on Proxmox with basic configuration
#
# This is a standalone playbook for LXC provisioning only.
# Does NOT install Docker or any applications.
#
# AAP Usage:
#   - Job Template: "Provision LXC"
#   - Used as second node in "Provision Docker LXC" workflow
#   - Credentials Required: "Proxmox Production"
#   - Survey provides: target_vmid, target_ip, target_hostname, tshirt_size
#
# Manual Usage:
#   export PROXMOX_SRE_BOT_API_TOKEN="your-token"
#   ansible-playbook playbooks/provision-lxc.yaml \
#     -e target_vmid=220 \
#     -e target_ip=172.16.100.20 \
#     -e target_hostname=my-container
# ============================================================================

- name: "Provision LXC Container"
  hosts: localhost
  connection: local
  gather_facts: false

  pre_tasks:
    # ========================================
    # Resolve variables via set_fact to avoid recursion
    # ========================================
    - name: "Resolve input variables"
      ansible.builtin.set_fact:
        resolved_vmid: "{{ target_vmid | default('') }}"
        resolved_ip: "{{ target_ip | default('') }}"
        resolved_hostname: "{{ target_hostname | default('docker-lxc') }}"
        resolved_size: "{{ tshirt_size | default('medium') }}"
        resolved_os: "{{ os_type | default('ubuntu24') }}"
        resolved_node: "{{ proxmox_node | default('wow-prox1') }}"
        resolved_network: "{{ network_profile | default('apps') }}"

    - name: "Validate required inputs"
      ansible.builtin.fail:
        msg: |
          Missing required inputs!

          Required:
            - target_vmid: Container ID (e.g., 220)
            - target_ip: IP address (e.g., 172.16.100.20)

          These should come from the Workflow Survey.
      when: resolved_vmid == '' or resolved_ip == ''

    - name: "Validate Proxmox credentials"
      ansible.builtin.fail:
        msg: |
          Proxmox API token not found!

          Ensure "Proxmox Production" credential is attached to the Job Template.
          The credential should inject PROXMOX_SRE_BOT_API_TOKEN environment variable.
      when: lookup('env', 'PROXMOX_SRE_BOT_API_TOKEN') == ''

    - name: "Display provisioning parameters"
      ansible.builtin.debug:
        msg:
          - "==========================================="
          - "LXC Container Provisioning"
          - "==========================================="
          - "Container ID: {{ resolved_vmid }}"
          - "IP Address: {{ resolved_ip }}"
          - "Hostname: {{ resolved_hostname }}"
          - "Size: {{ resolved_size }}"
          - "OS: {{ resolved_os }}"
          - "Proxmox Node: {{ resolved_node }}"
          - "Network: {{ resolved_network }}"
          - "==========================================="

  tasks:
    # ========================================
    # Phase 1: Provision LXC via Proxmox API
    # ========================================

    - name: "Provision LXC container via role"
      ansible.builtin.include_role:
        name: provision_lxc_generic
      vars:
        vmid: "{{ resolved_vmid }}"
        ansible_host: "{{ resolved_ip }}"
        inventory_hostname: "{{ resolved_hostname }}"
        tshirt_size: "{{ resolved_size }}"
        os_type: "{{ resolved_os }}"
        lxc_features: "nesting=1"
        proxmox_node: "{{ resolved_node }}"
        health_check_enabled: false
        post_provisioning_enabled: false
        skip_existing_check: false

    # ========================================
    # Phase 2: Wait for Container to Boot
    # ========================================

    - name: "Wait for container SSH to be available"
      ansible.builtin.wait_for:
        host: "{{ resolved_ip }}"
        port: 22
        delay: 10
        timeout: 120
        msg: "SSH not available on {{ resolved_ip }} after 120 seconds"

    # Setup known_hosts for AAP runner (ephemeral container)
    - name: "Setup SSH known_hosts for target"
      ansible.builtin.shell: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan -H {{ resolved_ip }} >> ~/.ssh/known_hosts 2>/dev/null
      changed_when: false
      failed_when: false

    - name: "✅ LXC Container Created"
      ansible.builtin.debug:
        msg:
          - "==========================================="
          - "✅ LXC Container Created Successfully"
          - "==========================================="
          - "VMID: {{ resolved_vmid }}"
          - "IP: {{ resolved_ip }}"
          - "Hostname: {{ resolved_hostname }}"
          - "SSH Port: 22 (verified accessible)"
          - ""
          - "Next step: Install Docker"
          - "==========================================="

    # ========================================
    # Output for Workflow
    # ========================================
    # Note: set_stats passes variables to the next workflow node

    - name: "Set stats for workflow"
      ansible.builtin.set_stats:
        data:
          target_ip: "{{ resolved_ip }}"
          target_vmid: "{{ resolved_vmid }}"
          target_hostname: "{{ resolved_hostname }}"
