---
# ============================================================================
# Deploy Docker Socket Proxy (Modular)
# ============================================================================
# Description: Deploy tecnativa/docker-socket-proxy to a generic Docker host.
#              This allows remote Traefik instances to discover containers
#              via TCP port 2375 without exposing the raw unix socket.
#
# AAP Usage:
#   - Job Template: "Deploy Docker Socket Proxy"
#   - Credentials: "AAP Executor SSH"
#   - Survey: target_ip (The IP of the LXC running Docker)
# ============================================================================

- name: "Prepare Modular Socket Proxy"
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:
    - name: "Validate input"
      ansible.builtin.fail:
        msg: "target_ip is missing! Please provide via AAP Survey."
      when: target_ip is not defined or target_ip == ""

    - name: "Setup SSH known_hosts"
      ansible.builtin.shell: |
        mkdir -p ~/.ssh
        ssh-keyscan -H {{ target_ip }} >> ~/.ssh/known_hosts 2>/dev/null
      changed_when: false
      failed_when: false

    - name: "Add target to runtime inventory"
      ansible.builtin.add_host:
        name: "{{ target_ip }}"
        groups: dynamic_targets
        ansible_user: root

- name: "Deploy Socket Proxy to Target"
  hosts: dynamic_targets
  gather_facts: true

  vars:
    install_dir: /opt/docker-socket-proxy

  tasks:
    - name: "Create installation directory"
      ansible.builtin.file:
        path: "{{ install_dir }}"
        state: directory
        mode: '0755'

    - name: "Deploy docker-compose.yml"
      ansible.builtin.copy:
        dest: "{{ install_dir }}/docker-compose.yml"
        mode: '0644'
        content: |
          services:
            socket-proxy:
              image: tecnativa/docker-socket-proxy:latest
              container_name: docker-socket-proxy
              restart: unless-stopped
              environment:
                - CONTAINERS=1
                - NETWORKS=1
                - SERVICES=1
                - SWARM=1
                - TASKS=1
                - EVENTS=1
                - POST=0 # Read-only access
              volumes:
                - /var/run/docker.sock:/var/run/docker.sock:ro
              ports:
                - "2375:2375"
              networks:
                - socket-proxy-net

          networks:
            socket-proxy-net:
              driver: bridge

    - name: "Start Socket Proxy"
      ansible.builtin.command:
        cmd: docker compose up -d
        chdir: "{{ install_dir }}"
      register: compose_out
      changed_when: "'Started' in compose_out.stderr or 'Created' in compose_out.stderr"

    - name: "Verify Port 2375 is listening"
      ansible.builtin.wait_for:
        port: 2375
        host: "{{ ansible_host }}"
        timeout: 15

    - name: "âœ… Deployment Summary"
      ansible.builtin.debug:
        msg:
          - "Docker Socket Proxy is now ACTIVE on {{ ansible_host }}:2375"
          - "Traefik can now use: tcp://{{ ansible_host }}:2375"
