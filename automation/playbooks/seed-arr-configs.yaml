---
# ============================================================================
# Seed Arr Configurations
# ============================================================================
# Description: Configure Quality Profiles and Custom Formats in Sonarr/Radarr
#
# AAP Usage:
#   - Job Template: "Seed Arr Configs"
#   - Credentials: "Media Arr API Keys"
#   - Survey: lxc_ip
# ============================================================================

- name: "Configure Arr Media Brains"
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    target_ip: "{{ lxc_ip | default('172.16.100.20') }}"

    # -------------------------------------------------------
    # Custom Format Definitions (Trash Guides Logic)
    # -------------------------------------------------------
    custom_formats:
      - name: "x265/HEVC"
        includeCustomFormatWhenRenaming: true
        specifications:
          - name: "x265"
            implementation: "ReleaseTitleSpecification"
            negate: false
            required: false
            fields:
              - { "name": "value", "value": "\\b(x265|hevc)\\b" }

      - name: "Remux"
        includeCustomFormatWhenRenaming: true
        specifications:
          - name: "Remux"
            implementation: "ReleaseTitleSpecification"
            negate: false
            required: false
            fields:
              - { "name": "value", "value": "\\b(remux)\\b" }

  tasks:
    # ========================================
    # Phase 1: Configure Radarr
    # ========================================
    - name: "Radarr: Sync Custom Formats"
      block:
        - name: "Radarr: Get existing Custom Formats"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:7878/api/v3/customformat"
            method: GET
            headers: { "X-Api-Key": "{{ radarr_api_key }}" }
          register: radarr_cf_existing

        - name: "Radarr: Create missing Custom Formats"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:7878/api/v3/customformat"
            method: POST
            headers: { "X-Api-Key": "{{ radarr_api_key }}" }
            body_format: json
            body: "{{ item }}"
            status_code: [201, 202]
          loop: "{{ custom_formats }}"
          when: item.name not in (radarr_cf_existing.json | map(attribute='name') | list)

        - name: "Radarr: Get existing Quality Profiles"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:7878/api/v3/qualityprofile"
            method: GET
            headers: { "X-Api-Key": "{{ radarr_api_key }}" }
          register: radarr_qp_existing

        - name: "Radarr: Get final Custom Formats for IDs"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:7878/api/v3/customformat"
            method: GET
            headers: { "X-Api-Key": "{{ radarr_api_key }}" }
          register: radarr_cf_final

        # -- Cloud-Unlimited --
        - name: "Radarr: Transform Cloud-Unlimited"
          block:
            - name: "Radarr: Build Cloud-Unlimited Items"
              ansible.builtin.set_fact:
                radarr_cloud_items: "{{ radarr_cloud_items | default([]) + [item | combine({'allowed': allowed})] }}"
              loop: "{{ (radarr_qp_existing.json | selectattr('name', 'equalto', 'Cloud-Unlimited') | first)['items'] }}"
              vars:
                allowed: "{{ (item.quality is defined and item.quality.id in [31, 19, 18, 17]) or (item.id is defined and item.id == 1003) }}"

            - name: "Radarr: PUT Cloud-Unlimited"
              ansible.builtin.uri:
                url: "http://{{ target_ip }}:7878/api/v3/qualityprofile/{{ profile.id }}"
                method: PUT
                headers: { "X-Api-Key": "{{ radarr_api_key }}" }
                body_format: json
                body: "{{ profile | combine({
                    'formatItems': [
                      {'format': remux_id, 'name': 'Remux', 'score': 1000},
                      {'format': x265_id, 'name': 'x265/HEVC', 'score': 0}
                    ],
                    'minUpgradeFormatScore': 1,
                    'upgradeAllowed': true,
                    'cutoff': 31,
                    'items': radarr_cloud_items
                  }) }}"
                status_code: [200, 202]
              vars:
                profile: "{{ radarr_qp_existing.json | selectattr('name', 'equalto', 'Cloud-Unlimited') | first }}"
                remux_id: "{{ (radarr_cf_final.json | selectattr('name', 'equalto', 'Remux') | first).id }}"
                x265_id: "{{ (radarr_cf_final.json | selectattr('name', 'equalto', 'x265/HEVC') | first).id }}"
          when: "'Cloud-Unlimited' in (radarr_qp_existing.json | map(attribute='name') | list)"

        # -- NAS-Archive --
        - name: "Radarr: Transform NAS-Archive"
          block:
            - name: "Radarr: Build NAS-Archive Items"
              ansible.builtin.set_fact:
                radarr_nas_items: "{{ radarr_nas_items | default([]) + [item | combine({'allowed': allowed})] }}"
              loop: "{{ (radarr_qp_existing.json | selectattr('name', 'equalto', 'NAS-Archive') | first)['items'] }}"
              vars:
                allowed: "{{ (item.quality is defined and item.quality.id in [7, 3, 9, 15]) or (item.id is defined and item.id == 1002) }}"

            - name: "Radarr: PUT NAS-Archive"
              ansible.builtin.uri:
                url: "http://{{ target_ip }}:7878/api/v3/qualityprofile/{{ profile.id }}"
                method: PUT
                headers: { "X-Api-Key": "{{ radarr_api_key }}" }
                body_format: json
                body: "{{ profile | combine({
                    'formatItems': [
                      {'format': x265_id, 'name': 'x265/HEVC', 'score': 1000},
                      {'format': remux_id, 'name': 'Remux', 'score': 0}
                    ],
                    'minUpgradeFormatScore': 1,
                    'upgradeAllowed': true,
                    'cutoff': 7,
                    'items': radarr_nas_items
                  }) }}"
                status_code: [200, 202]
              vars:
                profile: "{{ radarr_qp_existing.json | selectattr('name', 'equalto', 'NAS-Archive') | first }}"
                remux_id: "{{ (radarr_cf_final.json | selectattr('name', 'equalto', 'Remux') | first).id }}"
                x265_id: "{{ (radarr_cf_final.json | selectattr('name', 'equalto', 'x265/HEVC') | first).id }}"
          when: "'NAS-Archive' in (radarr_qp_existing.json | map(attribute='name') | list)"

    # ========================================
    # Phase 2: Configure Sonarr
    # ========================================
    - name: "Sonarr: Sync Configuration"
      block:
        - name: "Sonarr: Get existing Custom Formats"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:8989/api/v3/customformat"
            method: GET
            headers: { "X-Api-Key": "{{ sonarr_api_key }}" }
          register: sonarr_cf_existing

        - name: "Sonarr: Create missing Custom Formats"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:8989/api/v3/customformat"
            method: POST
            headers: { "X-Api-Key": "{{ sonarr_api_key }}" }
            body_format: json
            body: "{{ item }}"
            status_code: [201, 202]
          loop: "{{ custom_formats }}"
          when: item.name not in (sonarr_cf_existing.json | map(attribute='name') | list)

        - name: "Sonarr: Get existing Quality Profiles"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:8989/api/v3/qualityprofile"
            method: GET
            headers: { "X-Api-Key": "{{ sonarr_api_key }}" }
          register: sonarr_qp_existing

        - name: "Sonarr: Get final Custom Formats for IDs"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:8989/api/v3/customformat"
            method: GET
            headers: { "X-Api-Key": "{{ sonarr_api_key }}" }
          register: sonarr_cf_final

        # -- Cloud-Unlimited --
        - name: "Sonarr: Transform Cloud-Unlimited"
          block:
            - name: "Sonarr: Build Cloud-Unlimited Items"
              ansible.builtin.set_fact:
                sonarr_cloud_items: "{{ sonarr_cloud_items | default([]) + [item | combine({'allowed': allowed})] }}"
              loop: "{{ (sonarr_qp_existing.json | selectattr('name', 'equalto', 'Cloud-Unlimited') | first)['items'] }}"
              vars:
                allowed: "{{ (item.quality is defined and item.quality.id in [21, 19, 18, 17]) or (item.id is defined and item.id == 1003) }}"

            - name: "Sonarr: PUT Cloud-Unlimited"
              ansible.builtin.uri:
                url: "http://{{ target_ip }}:8989/api/v3/qualityprofile/{{ profile.id }}"
                method: PUT
                headers: { "X-Api-Key": "{{ sonarr_api_key }}" }
                body_format: json
                body: "{{ profile | combine({
                    'formatItems': [
                      {'format': remux_id, 'name': 'Remux', 'score': 1000},
                      {'format': x265_id, 'name': 'x265/HEVC', 'score': 0}
                    ],
                    'minUpgradeFormatScore': 1,
                    'upgradeAllowed': true,
                    'cutoff': 21,
                    'items': sonarr_cloud_items
                  }) }}"
                status_code: [200, 202]
              vars:
                profile: "{{ sonarr_qp_existing.json | selectattr('name', 'equalto', 'Cloud-Unlimited') | first }}"
                remux_id: "{{ (sonarr_cf_final.json | selectattr('name', 'equalto', 'Remux') | first).id }}"
                x265_id: "{{ (sonarr_cf_final.json | selectattr('name', 'equalto', 'x265/HEVC') | first).id }}"
          when: "'Cloud-Unlimited' in (sonarr_qp_existing.json | map(attribute='name') | list)"

        # -- NAS-Archive --
        - name: "Sonarr: Transform NAS-Archive"
          block:
            - name: "Sonarr: Build NAS-Archive Items"
              ansible.builtin.set_fact:
                sonarr_nas_items: "{{ sonarr_nas_items | default([]) + [item | combine({'allowed': allowed})] }}"
              loop: "{{ (sonarr_qp_existing.json | selectattr('name', 'equalto', 'NAS-Archive') | first)['items'] }}"
              vars:
                allowed: "{{ (item.quality is defined and item.quality.id in [7, 3, 9, 15, 6]) or (item.id is defined and item.id == 1002) }}"

            - name: "Sonarr: PUT NAS-Archive"
              ansible.builtin.uri:
                url: "http://{{ target_ip }}:8989/api/v3/qualityprofile/{{ profile.id }}"
                method: PUT
                headers: { "X-Api-Key": "{{ sonarr_api_key }}" }
                body_format: json
                body: "{{ profile | combine({
                    'formatItems': [
                      {'format': x265_id, 'name': 'x265/HEVC', 'score': 1000},
                      {'format': remux_id, 'name': 'Remux', 'score': 0}
                    ],
                    'minUpgradeFormatScore': 1,
                    'upgradeAllowed': true,
                    'cutoff': 7,
                    'items': sonarr_nas_items
                  }) }}"
                status_code: [200, 202]
              vars:
                profile: "{{ sonarr_qp_existing.json | selectattr('name', 'equalto', 'NAS-Archive') | first }}"
                remux_id: "{{ (sonarr_cf_final.json | selectattr('name', 'equalto', 'Remux') | first).id }}"
                x265_id: "{{ (sonarr_cf_final.json | selectattr('name', 'equalto', 'x265/HEVC') | first).id }}"
          when: "'NAS-Archive' in (sonarr_qp_existing.json | map(attribute='name') | list)"
