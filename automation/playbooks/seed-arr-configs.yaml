---
# ============================================================================
# Seed Arr Configurations
# ============================================================================
# Description: Configure Quality Profiles and Custom Formats in Sonarr/Radarr
#
# AAP Usage:
#   - Job Template: "Seed Arr Configs"
#   - Credentials: "Media Arr API Keys"
#   - Survey: lxc_ip
# ============================================================================

- name: "Configure Arr Media Brains"
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    target_ip: "{{ lxc_ip | default('172.16.100.20') }}"
    
    # -------------------------------------------------------
    # Custom Format Definitions (Trash Guides Logic)
    # -------------------------------------------------------
    custom_formats:
      - name: "x265/HEVC"
        includeCustomFormatWhenRenaming: true
        specifications:
          - name: "x265"
            implementation: "ReleaseTitleSpecification"
            negate: false
            required: false
            fields: 
              - { "name": "value", "value": "\\b(x265|hevc)\\b" }
      
      - name: "Remux"
        includeCustomFormatWhenRenaming: true
        specifications:
          - name: "Remux"
            implementation: "ReleaseTitleSpecification"
            negate: false
            required: false
            fields: 
              - { "name": "value", "value": "\\b(remux)\\b" }

  tasks:
    # ========================================
    # Phase 1: Configure Radarr
    # ========================================
    - name: "Radarr: Sync Configuration"
      block:
        - name: "Radarr: Get existing Custom Formats"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:7878/api/v3/customformat"
            method: GET
            headers: { "X-Api-Key": "{{ radarr_api_key }}" }
          register: radarr_cf_existing

        - name: "Radarr: Create missing Custom Formats"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:7878/api/v3/customformat"
            method: POST
            headers: { "X-Api-Key": "{{ radarr_api_key }}" }
            body_format: json
            body: "{{ item }}"
            status_code: [201, 202]
          loop: "{{ custom_formats }}"
          when: item.name not in (radarr_cf_existing.json | map(attribute='name') | list)

        - name: "Radarr: Get final Custom Formats for IDs"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:7878/api/v3/customformat"
            method: GET
            headers: { "X-Api-Key": "{{ radarr_api_key }}" }
          register: radarr_cf_final

        - name: "Radarr: Get existing Quality Profiles"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:7878/api/v3/qualityprofile"
            method: GET
            headers: { "X-Api-Key": "{{ radarr_api_key }}" }
          register: radarr_qp_existing

        - name: "Radarr: Update Cloud-Unlimited Profile"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:7878/api/v3/qualityprofile/{{ profile.id }}"
            method: PUT
            headers: { "X-Api-Key": "{{ radarr_api_key }}" }
            body_format: json
            body: >-
              {% set new_items = [] %}
              {% for item in profile.items %}
                {% set is_allowed = false %}
                {% if item.quality is defined and item.quality.id in [31, 19, 18, 17] %}
                  {% set is_allowed = true %}
                {% elif item.id is defined and item.id == 1003 %}
                  {% set is_allowed = true %}
                {% endif %}
                {% set _ = new_items.append(item | combine({'allowed': is_allowed})) %}
              {% endfor %}
              {{ profile | combine({
                'formatItems': [
                  {'format': remux_id, 'name': 'Remux', 'score': 1000},
                  {'format': x265_id, 'name': 'x265/HEVC', 'score': 0}
                ], 
                'minUpgradeFormatScore': 1,
                'upgradeAllowed': true,
                'cutoff': 31,
                'items': new_items
              }) }}
          vars:
            profile: "{{ radarr_qp_existing.json | selectattr('name', 'equalto', 'Cloud-Unlimited') | first }}"
            remux_id: "{{ (radarr_cf_final.json | selectattr('name', 'equalto', 'Remux') | first).id }}"
            x265_id: "{{ (radarr_cf_final.json | selectattr('name', 'equalto', 'x265/HEVC') | first).id }}"
          when: "'Cloud-Unlimited' in (radarr_qp_existing.json | map(attribute='name') | list)"

        - name: "Radarr: Update NAS-Archive Profile"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:7878/api/v3/qualityprofile/{{ profile.id }}"
            method: PUT
            headers: { "X-Api-Key": "{{ radarr_api_key }}" }
            body_format: json
            body: >-
              {% set new_items = [] %}
              {% for item in profile.items %}
                {% set is_allowed = false %}
                {% if item.quality is defined and item.quality.id in [7, 3, 9, 15] %}
                  {% set is_allowed = true %}
                {% elif item.id is defined and item.id == 1002 %}
                  {% set is_allowed = true %}
                {% endif %}
                {% set _ = new_items.append(item | combine({'allowed': is_allowed})) %}
              {% endfor %}
              {{ profile | combine({
                'formatItems': [
                  {'format': x265_id, 'name': 'x265/HEVC', 'score': 1000},
                  {'format': remux_id, 'name': 'Remux', 'score': 0}
                ], 
                'minUpgradeFormatScore': 1,
                'upgradeAllowed': true,
                'cutoff': 7,
                'items': new_items
              }) }}
          vars:
            profile: "{{ radarr_qp_existing.json | selectattr('name', 'equalto', 'NAS-Archive') | first }}"
            remux_id: "{{ (radarr_cf_final.json | selectattr('name', 'equalto', 'Remux') | first).id }}"
            x265_id: "{{ (radarr_cf_final.json | selectattr('name', 'equalto', 'x265/HEVC') | first).id }}"
          when: "'NAS-Archive' in (radarr_qp_existing.json | map(attribute='name') | list)"

    # ========================================
    # Phase 2: Configure Sonarr
    # ========================================
    - name: "Sonarr: Sync Configuration"
      block:
        - name: "Sonarr: Get existing Custom Formats"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:8989/api/v3/customformat"
            method: GET
            headers: { "X-Api-Key": "{{ sonarr_api_key }}" }
          register: sonarr_cf_existing

        - name: "Sonarr: Create missing Custom Formats"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:8989/api/v3/customformat"
            method: POST
            headers: { "X-Api-Key": "{{ sonarr_api_key }}" }
            body_format: json
            body: "{{ item }}"
            status_code: [201, 202]
          loop: "{{ custom_formats }}"
          when: item.name not in (sonarr_cf_existing.json | map(attribute='name') | list)

        - name: "Sonarr: Get final Custom Formats for IDs"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:8989/api/v3/customformat"
            method: GET
            headers: { "X-Api-Key": "{{ sonarr_api_key }}" }
          register: sonarr_cf_final

        - name: "Sonarr: Get existing Quality Profiles"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:8989/api/v3/qualityprofile"
            method: GET
            headers: { "X-Api-Key": "{{ sonarr_api_key }}" }
          register: sonarr_qp_existing

        - name: "Sonarr: Update Cloud-Unlimited Profile"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:8989/api/v3/qualityprofile/{{ profile.id }}"
            method: PUT
            headers: { "X-Api-Key": "{{ sonarr_api_key }}" }
            body_format: json
            body: >-
              {% set new_items = [] %}
              {% for item in profile.items %}
                {% set is_allowed = false %}
                {% if item.quality is defined and item.quality.id in [21, 19, 18, 17] %}
                  {% set is_allowed = true %}
                {% elif item.id is defined and item.id == 1003 %}
                  {% set is_allowed = true %}
                {% endif %}
                {% set _ = new_items.append(item | combine({'allowed': is_allowed})) %}
              {% endfor %}
              {{ profile | combine({
                'formatItems': [
                  {'format': remux_id, 'name': 'Remux', 'score': 1000},
                  {'format': x265_id, 'name': 'x265/HEVC', 'score': 0}
                ], 
                'minUpgradeFormatScore': 1,
                'upgradeAllowed': true,
                'cutoff': 21,
                'items': new_items
              }) }}
          vars:
            profile: "{{ sonarr_qp_existing.json | selectattr('name', 'equalto', 'Cloud-Unlimited') | first }}"
            remux_id: "{{ (sonarr_cf_final.json | selectattr('name', 'equalto', 'Remux') | first).id }}"
            x265_id: "{{ (sonarr_cf_final.json | selectattr('name', 'equalto', 'x265/HEVC') | first).id }}"
          when: "'Cloud-Unlimited' in (sonarr_qp_existing.json | map(attribute='name') | list)"

        - name: "Sonarr: Update NAS-Archive Profile"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:8989/api/v3/qualityprofile/{{ profile.id }}"
            method: PUT
            headers: { "X-Api-Key": "{{ sonarr_api_key }}" }
            body_format: json
            body: >-
              {% set new_items = [] %}
              {% for item in profile.items %}
                {% set is_allowed = false %}
                {% if item.quality is defined and item.quality.id in [7, 3, 9, 15, 6] %}
                  {% set is_allowed = true %}
                {% elif item.id is defined and item.id == 1002 %}
                  {% set is_allowed = true %}
                {% endif %}
                {% set _ = new_items.append(item | combine({'allowed': is_allowed})) %}
              {% endfor %}
              {{ profile | combine({
                'formatItems': [
                  {'format': x265_id, 'name': 'x265/HEVC', 'score': 1000},
                  {'format': remux_id, 'name': 'Remux', 'score': 0}
                ], 
                'minUpgradeFormatScore': 1,
                'upgradeAllowed': true,
                'cutoff': 7,
                'items': new_items
              }) }}
          vars:
            profile: "{{ sonarr_qp_existing.json | selectattr('name', 'equalto', 'NAS-Archive') | first }}"
            remux_id: "{{ (sonarr_cf_final.json | selectattr('name', 'equalto', 'Remux') | first).id }}"
            x265_id: "{{ (sonarr_cf_final.json | selectattr('name', 'equalto', 'x265/HEVC') | first).id }}"
          when: "'NAS-Archive' in (sonarr_qp_existing.json | map(attribute='name') | list)"
