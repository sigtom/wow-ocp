---
# ============================================================================
# Seed Arr Configurations
# ============================================================================
# Description: Configure Quality Profiles and Custom Formats in Sonarr/Radarr
#
# AAP Usage:
#   - Job Template: "Seed Arr Configs"
#   - Credentials: "Media Arr API Keys"
#   - Survey: lxc_ip
# ============================================================================

- name: "Configure Arr Media Brains"
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    target_ip: "{{ lxc_ip | default('172.16.100.20') }}"
    
    # -------------------------------------------------------
    # Custom Format Definitions (Trash Guides Logic)
    # -------------------------------------------------------
    custom_formats:
      - name: "x265/HEVC"
        includeCustomFormatWhenRenaming: true
        specifications:
          - name: "x265"
            implementation: "ReleaseTitleSpecification"
            negate: false
            required: false
            fields: 
              - { "name": "value", "value": "\\b(x265|hevc)\\b" }
      
      - name: "Remux"
        includeCustomFormatWhenRenaming: true
        specifications:
          - name: "Remux"
            implementation: "ReleaseTitleSpecification"
            negate: false
            required: false
            fields: 
              - { "name": "value", "value": "\\b(remux)\\b" }

  tasks:
    # ========================================
    # Phase 1: Configure Radarr
    # ========================================
    - name: "Radarr: Sync Custom Formats"
      block:
        - name: "Radarr: Get existing Custom Formats"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:7878/api/v3/customformat"
            method: GET
            headers: { "X-Api-Key": "{{ radarr_api_key }}" }
          register: radarr_cf_existing

        - name: "Radarr: Sync Custom Formats"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:7878/api/v3/customformat"
            method: POST
            headers: { "X-Api-Key": "{{ radarr_api_key }}" }
            body_format: json
            body: "{{ item }}"
            status_code: [201, 202]
          loop: "{{ custom_formats }}"
          when: item.name not in (radarr_cf_existing.json | map(attribute='name') | list)

    # ========================================
    # Phase 2: Configure Sonarr
    # ========================================
    - name: "Sonarr: Sync Custom Formats"
      block:
        - name: "Sonarr: Get existing Custom Formats"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:8989/api/v3/customformat"
            method: GET
            headers: { "X-Api-Key": "{{ sonarr_api_key }}" }
          register: sonarr_cf_existing

        - name: "Sonarr: Sync Custom Formats"
          ansible.builtin.uri:
            url: "http://{{ target_ip }}:8989/api/v3/customformat"
            method: POST
            headers: { "X-Api-Key": "{{ sonarr_api_key }}" }
            body_format: json
            body: "{{ item }}"
            status_code: [201, 202]
          loop: "{{ custom_formats }}"
          when: item.name not in (sonarr_cf_existing.json | map(attribute='name') | list)
