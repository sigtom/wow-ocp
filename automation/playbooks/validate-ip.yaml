---
# ============================================================================
# Validate IP Availability
# ============================================================================
# Description: Check if an IP address is available for use
#
# Checks performed:
#   1. Ping test - fail if host responds
#   2. Reverse DNS lookup - warn if PTR record exists
#
# AAP Usage:
#   - Job Template: "Validate IP"
#   - Used as first node in "Provision Docker LXC" workflow
#   - No credentials required (runs on localhost)
#
# Manual Usage:
#   ansible-playbook playbooks/validate-ip.yaml -e target_ip=172.16.100.20
# ============================================================================

- name: "Validate IP Availability"
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    target_ip: "{{ target_ip | default('') }}"

  tasks:
    - name: "Validate target_ip is provided"
      ansible.builtin.fail:
        msg: "target_ip is required. Provide via Survey or -e target_ip=172.16.100.20"
      when: target_ip == ""

    - name: "Display IP being validated"
      ansible.builtin.debug:
        msg:
          - "==========================================="
          - "Validating IP Availability: {{ target_ip }}"
          - "==========================================="

    # ========================================
    # Check 1: Ping Test
    # ========================================

    - name: "Ping test - check if IP responds"
      ansible.builtin.command:
        cmd: "ping -c 2 -W 2 {{ target_ip }}"
      register: ping_result
      failed_when: false
      changed_when: false

    - name: "FAIL - IP is already in use"
      ansible.builtin.fail:
        msg: |
          ❌ IP {{ target_ip }} is ALREADY IN USE!

          Ping response received - another host is using this IP.

          Choose a different IP address and try again.

          Available range: 172.16.100.12-14, 172.16.100.17-49
      when: ping_result.rc == 0

    - name: "✅ Ping test passed - IP does not respond"
      ansible.builtin.debug:
        msg: "IP {{ target_ip }} does not respond to ping - good!"

    # ========================================
    # Check 2: Reverse DNS Lookup
    # ========================================

    - name: "Reverse DNS lookup - check for existing PTR record"
      ansible.builtin.command:
        cmd: "host {{ target_ip }}"
      register: rdns_result
      failed_when: false
      changed_when: false

    - name: "Parse rDNS result"
      ansible.builtin.set_fact:
        has_ptr_record: "{{ 'pointer' in rdns_result.stdout }}"
        ptr_hostname: "{{ rdns_result.stdout.split('pointer ')[-1] | trim if 'pointer' in rdns_result.stdout else '' }}"

    - name: "⚠️ WARNING - PTR record exists"
      ansible.builtin.debug:
        msg:
          - "==========================================="
          - "⚠️  WARNING: PTR record exists for {{ target_ip }}"
          - "==========================================="
          - "Hostname: {{ ptr_hostname }}"
          - ""
          - "This IP may have been used previously."
          - "Proceeding anyway - clean up DNS later."
          - "==========================================="
      when: has_ptr_record

    - name: "✅ No PTR record found"
      ansible.builtin.debug:
        msg: "No reverse DNS record for {{ target_ip }} - clean slate!"
      when: not has_ptr_record

    # ========================================
    # Final Summary
    # ========================================

    - name: "✅ IP Validation Complete"
      ansible.builtin.debug:
        msg:
          - "==========================================="
          - "✅ IP {{ target_ip }} is AVAILABLE"
          - "==========================================="
          - "Ping test: PASSED (no response)"
          - "rDNS check: {{ 'WARNING - PTR exists' if has_ptr_record else 'PASSED (no PTR)' }}"
          - ""
          - "Ready for provisioning!"
          - "==========================================="
