---
- name: "Tier 0 Identity: Deploy IdM Server on Proxmox VM"
  hosts: all
  serial: 1
  gather_facts: false

  vars_files:
    - "{{ playbook_dir }}/../../inventory/group_vars/all.yml"

  tasks:
    - name: "Phase 1: Provision IdM VM on Proxmox"
      ansible.builtin.include_role:
        name: provision_vm_generic
      vars:
        vmid: "{{ hostvars[inventory_hostname].vmid }}"
        ansible_host: "{{ hostvars[inventory_hostname].ansible_host }}"
        proxmox_node: "{{ hostvars[inventory_hostname].proxmox_node }}"
        os_type: "{{ hostvars[inventory_hostname].os_type | default('rhel') }}"
        tshirt_size: "{{ hostvars[inventory_hostname].tshirt_size | default('medium') }}"
        proxmox_vmtype: "vm"
      when: hostvars[inventory_hostname].vmid is defined

    - name: "Phase 2: Ensure SSH Access"
      ansible.builtin.include_role:
        name: bootstrap_ssh

    - name: "Phase 3: Gather Facts"
      ansible.builtin.setup:

    - name: "Phase 4: Configure IdM Server"
      ansible.builtin.include_role:
        name: idm_server
