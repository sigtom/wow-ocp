---
# ============================================================================
# SSH Key Bootstrap Utility (Refactored)
# ============================================================================
# Description: Inject an SSH public key into an LXC or VM on Proxmox.
#              Uses the bootstrap_ssh role for reliable injection.
#
# AAP Usage:
#   - Job Template: "Util - SSH Bootstrap"
#   - Credentials: "Proxmox Production", "AAP Executor SSH"
#   - Survey: target_ip, bootstrap_force
# ============================================================================

- name: "SSH Key Bootstrap Utility - Initialization"
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: "Add manual target to inventory if IP provided"
      ansible.builtin.add_host:
        name: "{{ target_ip }}"
        groups: manual_targets
        ansible_user: root
      when: target_ip | default('') | length > 0

- name: "SSH Key Bootstrap Utility - Execution"
  hosts: "all:manual_targets:!localhost"
  gather_facts: false
  tasks:
    - name: "Run SSH Bootstrap Role"
      ansible.builtin.include_role:
        name: bootstrap_ssh
      vars:
        # Allow force mode from survey
        bootstrap_force: "{{ bootstrap_mode | default('false') | bool }}"

    - name: "Final Summary"
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "SSH Bootstrap Summary"
          - "=========================================="
          - "Host: {{ inventory_hostname }}"
          - "VMID: {{ proxmox_vmid | default('N/A') }}"
          - "Access Level: {{ id_res.stdout | default('Failed') }}"
          - "=========================================="
