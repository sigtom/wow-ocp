# External Secrets Operator + Bitwarden Architecture

## Overview

Replace SealedSecrets with **External Secrets Operator (ESO)** to sync secrets from Bitwarden vault directly into OpenShift. This eliminates manual secret management and provides a single source of truth.

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    Bitwarden Vault (vault.sigtom.dev)           │
│  Items: proxmox-token, nautobot-db-password, argocd-admin, etc  │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ bw CLI (authenticated with BW_SESSION)
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              External Secrets Operator (OpenShift)              │
│                                                                  │
│  ┌──────────────────┐         ┌──────────────────┐             │
│  │  SecretStore     │────────▶│  ExternalSecret  │             │
│  │  (Bitwarden      │         │  (References     │             │
│  │   connection)    │         │   BW items)      │             │
│  └──────────────────┘         └────────┬─────────┘             │
│                                         │                        │
│                                         ▼                        │
│                              ┌──────────────────┐                │
│                              │  Kubernetes      │                │
│                              │  Secret          │                │
│                              │  (Auto-created)  │                │
│                              └──────────────────┘                │
└─────────────────────────────────────────────────────────────────┘
                                         │
                                         │ Used by Pods
                                         ▼
                              ┌──────────────────┐
                              │  Applications    │
                              │  (Plex, Sonarr,  │
                              │   ArgoCD, etc)   │
                              └──────────────────┘
```

## Key Concepts

### 1. SecretStore
Defines **how** to connect to Bitwarden (authentication, CLI path, etc.)

### 2. ExternalSecret
Defines **what** secrets to fetch from Bitwarden and **where** to create them in OpenShift

### 3. Kubernetes Secret
Auto-generated by ESO - your applications consume these normally

## Workflow Comparison

### Old Way (SealedSecrets + Manual):
```bash
# Developer manually creates secret
echo -n "mypassword" | kubectl create secret generic my-secret --dry-run=client -o yaml --from-file=password=/dev/stdin > secret.yaml

# Developer seals it
kubeseal -f secret.yaml -w sealed-secret.yaml

# Commit sealed-secret.yaml to git
git add sealed-secret.yaml && git commit -m "Add sealed secret"

# SealedSecrets controller decrypts in cluster
# Secret created in cluster
```

**Problems:**
- ❌ Secrets stored encrypted in git (still visible structure)
- ❌ Manual sealing process
- ❌ Rotation requires re-sealing
- ❌ Backup/restore complexity
- ❌ Can't easily share secrets across namespaces/clusters

### New Way (ESO + Bitwarden):
```bash
# 1. Create item in Bitwarden vault (web UI or bw CLI)
bw create item '{"type":1,"name":"my-secret","login":{"password":"mypassword"}}'

# 2. Create ExternalSecret manifest (commit to git)
cat <<EOF > external-secret.yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: my-secret
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: bitwarden-store
    kind: ClusterSecretStore
  target:
    name: my-secret
  data:
    - secretKey: password
      remoteRef:
        key: my-secret
EOF

git add external-secret.yaml && git commit -m "Add external secret"

# 3. ESO automatically fetches from Bitwarden and creates Secret
# Done! Secret auto-synced every hour
```

**Benefits:**
- ✅ Single source of truth (Bitwarden)
- ✅ No secrets in git (not even encrypted)
- ✅ Automatic rotation (just update in Bitwarden)
- ✅ Multi-cluster support (same Bitwarden vault)
- ✅ Audit trail (Bitwarden logs)
- ✅ Easy backup/restore (Bitwarden handles it)

## Do We Still Use SealedSecrets?

**No, for cluster workloads.** ESO completely replaces SealedSecrets for:
- Application secrets (Plex, Sonarr, Radarr tokens)
- Database passwords
- API keys
- TLS certificates (can also use cert-manager)

**Yes, for bootstrap secrets.** You might keep SealedSecrets for:
- ESO's own Bitwarden credentials (chicken-egg problem)
- Super-critical cluster-admin credentials
- Break-glass emergency access

## Implementation Steps

### Step 1: Install External Secrets Operator

```bash
# Create namespace
oc create namespace external-secrets

# Install via OperatorHub (recommended) or Helm
# OperatorHub: OpenShift Console → OperatorHub → Search "External Secrets"
# Or via CLI:
cat <<EOF | oc apply -f -
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: external-secrets-operator
  namespace: openshift-operators
spec:
  channel: stable
  name: external-secrets-operator
  source: community-operators
  sourceNamespace: openshift-marketplace
EOF
```

### Step 2: Create Bitwarden CLI Secret (Bootstrap)

This is the **only** SealedSecret you need - it contains the BW_SESSION token:

```bash
# Option A: Use BSEC locally to get session
bsec exec -- printenv BW_SESSION

# Option B: Unlock Bitwarden manually
export BW_SESSION=$(bw unlock --raw)

# Create secret with session token
oc create secret generic bitwarden-cli \
  --from-literal=BW_SESSION="$BW_SESSION" \
  -n external-secrets \
  --dry-run=client -o yaml | \
  kubeseal --format yaml > bootstrap/sealed-secret-bitwarden-cli.yaml

# Commit this ONE sealed secret
git add bootstrap/sealed-secret-bitwarden-cli.yaml
git commit -m "Add Bitwarden CLI bootstrap secret"
```

**Note:** This session needs periodic renewal (typically 7 days). You can automate this with a CronJob.

### Step 3: Create ClusterSecretStore

This tells ESO how to connect to Bitwarden:

```yaml
# gitops/core/external-secrets/cluster-secret-store.yaml
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: bitwarden-store
spec:
  provider:
    bitwarden:
      # Point to your Bitwarden instance
      url: https://vault.sigtom.dev
      
      # CLI path in the operator pod
      cliPath: /usr/local/bin/bw
      
      # Reference to the session secret
      auth:
        secretRef:
          credentials:
            name: bitwarden-cli
            namespace: external-secrets
            key: BW_SESSION
```

```bash
git add gitops/core/external-secrets/cluster-secret-store.yaml
git commit -m "Add Bitwarden ClusterSecretStore"
```

### Step 4: Create ExternalSecrets for Your Apps

Now create ExternalSecret manifests for each application:

#### Example 1: Plex Token
```yaml
# gitops/apps/media/plex/external-secret.yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: plex-token
  namespace: media
spec:
  # Refresh from Bitwarden every hour
  refreshInterval: 1h
  
  # Use the cluster-wide Bitwarden store
  secretStoreRef:
    name: bitwarden-store
    kind: ClusterSecretStore
  
  # Create a Kubernetes Secret with this name
  target:
    name: plex-token
    creationPolicy: Owner
  
  # Map Bitwarden items to Secret keys
  data:
    - secretKey: PLEX_CLAIM
      remoteRef:
        key: plex-claim  # Name of item in Bitwarden
```

#### Example 2: Database Credentials (Multiple Fields)
```yaml
# gitops/apps/nautobot/external-secret.yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: nautobot-db-creds
  namespace: nautobot
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: bitwarden-store
    kind: ClusterSecretStore
  target:
    name: nautobot-db-creds
  data:
    # Multiple secrets from different Bitwarden items
    - secretKey: DB_PASSWORD
      remoteRef:
        key: nautobot-db-password
    
    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: nautobot-redis-password
    
    - secretKey: SECRET_KEY
      remoteRef:
        key: nautobot-secret-key
    
    - secretKey: ADMIN_PASSWORD
      remoteRef:
        key: nautobot-admin-password
```

#### Example 3: Using Custom Fields
```yaml
# gitops/apps/media/torbox/external-secret.yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: torbox-creds
  namespace: media
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: bitwarden-store
    kind: ClusterSecretStore
  target:
    name: torbox-creds
  data:
    # Get username field
    - secretKey: TORBOX_USERNAME
      remoteRef:
        key: torbox-username
        property: login.username  # Access username field
    
    # Get password field (default)
    - secretKey: TORBOX_PASSWORD
      remoteRef:
        key: torbox-password
    
    # Get API key from notes field
    - secretKey: TORBOX_API_KEY
      remoteRef:
        key: torbox-api-key
        property: notes  # Get from notes field
```

### Step 5: Application Deployment Uses Generated Secrets

Your existing Deployments/StatefulSets just reference the auto-generated Secrets:

```yaml
# gitops/apps/media/plex/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: plex
  namespace: media
spec:
  template:
    spec:
      containers:
      - name: plex
        image: plexinc/pms-docker:latest
        env:
          # Reference the secret created by ExternalSecret
          - name: PLEX_CLAIM
            valueFrom:
              secretKeyRef:
                name: plex-token  # Created by ESO
                key: PLEX_CLAIM
```

**No changes needed** to your existing app manifests! Just change where the Secret comes from.

## GitOps Workflow

### Repository Structure
```
wow-ocp/
├── bootstrap/
│   └── sealed-secret-bitwarden-cli.yaml  # Only SealedSecret needed
│
├── gitops/
│   ├── core/
│   │   └── external-secrets/
│   │       ├── namespace.yaml
│   │       ├── cluster-secret-store.yaml
│   │       └── session-renewal-cronjob.yaml  # Optional: auto-renew BW_SESSION
│   │
│   └── apps/
│       ├── media/
│       │   ├── plex/
│       │   │   ├── external-secret.yaml      # ESO config
│       │   │   ├── deployment.yaml           # Unchanged
│       │   │   └── service.yaml
│       │   ├── sonarr/
│       │   │   └── external-secret.yaml
│       │   └── radarr/
│       │       └── external-secret.yaml
│       │
│       └── nautobot/
│           ├── external-secret.yaml
│           ├── deployment.yaml
│           └── service.yaml
```

### Git Commits
```bash
# Before: Sealed every secret
git log --oneline
a1b2c3d Add sealed secret for Plex token
b2c3d4e Update sealed secret for Sonarr API key
c3d4e5f Rotate sealed DB password

# After: Just commit ExternalSecret manifests
git log --oneline
a1b2c3d Add ExternalSecret for Plex
b2c3d4e Add ExternalSecret for Sonarr
c3d4e5f Add ExternalSecret for Nautobot DB
```

**No actual secrets in git!** Just references to Bitwarden items.

## Secret Rotation Workflow

### Old Way (SealedSecrets):
```bash
# 1. Generate new password
NEW_PASS=$(openssl rand -base64 32)

# 2. Update application manually
ssh server "docker exec db mysql -e 'ALTER USER SET PASSWORD...'"

# 3. Re-seal secret
echo -n "$NEW_PASS" | kubectl create secret generic... | kubeseal...

# 4. Commit new sealed secret
git add sealed-secret.yaml && git commit -m "Rotate DB password"

# 5. Wait for ArgoCD sync

# 6. Restart pods to pick up new secret
kubectl rollout restart deployment/myapp
```

### New Way (ESO):
```bash
# 1. Generate new password
NEW_PASS=$(openssl rand -base64 32)

# 2. Update Bitwarden item
bw get item nautobot-db-password | \
  jq ".login.password = \"$NEW_PASS\"" | \
  bw edit item $(bw get item nautobot-db-password | jq -r .id) -

# 3. Done! ESO syncs automatically within refreshInterval
# Pods restart automatically if configured with reloader
```

**That's it!** No git commits, no re-sealing, no manual sync.

## Advanced: Automatic Pod Restart on Secret Change

Install **Reloader** to automatically restart pods when secrets change:

```yaml
# gitops/core/reloader/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: plex
  annotations:
    reloader.stakater.com/auto: "true"  # Auto-restart on secret/configmap change
spec:
  template:
    spec:
      containers:
      - name: plex
        env:
          - name: PLEX_CLAIM
            valueFrom:
              secretKeyRef:
                name: plex-token
                key: PLEX_CLAIM
```

When ESO updates `plex-token` Secret, Reloader automatically restarts the pod.

## Session Renewal Automation

The `BW_SESSION` token expires. Automate renewal with a CronJob:

```yaml
# gitops/core/external-secrets/session-renewal-cronjob.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: bitwarden-session-renewal
  namespace: external-secrets
spec:
  schedule: "0 0 * * 0"  # Weekly on Sunday
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: bitwarden-session-renewer
          containers:
          - name: renew
            image: bitwarden/cli:latest
            command:
            - /bin/sh
            - -c
            - |
              # Login and get new session
              export BW_SESSION=$(bw login --apikey --raw)
              
              # Update the secret
              oc patch secret bitwarden-cli \
                -n external-secrets \
                --type json \
                -p "[{\"op\":\"replace\",\"path\"/data/BW_SESSION\",\"value\":\"$(echo -n $BW_SESSION | base64 -w0)\"}]"
            env:
            - name: BW_CLIENTID
              valueFrom:
                secretKeyRef:
                  name: bitwarden-api-key
                  key: clientId
            - name: BW_CLIENTSECRET
              valueFrom:
                secretKeyRef:
                  name: bitwarden-api-key
                  key: clientSecret
          restartPolicy: OnFailure
```

## Bitwarden Setup for ESO

### Organize Secrets with Collections

```
Bitwarden Collections:
├── Homelab-Core
│   ├── proxmox-sre-token
│   ├── argocd-admin-password
│   └── vault-unseal-key
│
├── Homelab-Media
│   ├── plex-claim
│   ├── sonarr-api-key
│   ├── radarr-api-key
│   ├── torbox-api-key
│   └── real-debrid-api-key
│
└── Homelab-Apps
    ├── nautobot-db-password
    ├── nautobot-redis-password
    ├── nautobot-secret-key
    └── nautobot-admin-password
```

Filter ExternalSecrets by collection:

```yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: media-secrets
spec:
  secretStoreRef:
    name: bitwarden-store
    kind: ClusterSecretStore
  target:
    name: media-secrets
  dataFrom:
    - find:
        name:
          regexp: ".*"
        collection: Homelab-Media  # Only fetch from this collection
```

## Security Considerations

### 1. Namespace Isolation
Use `SecretStore` (namespaced) instead of `ClusterSecretStore` for sensitive apps:

```yaml
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: bitwarden-prod
  namespace: production
spec:
  provider:
    bitwarden:
      url: https://vault.sigtom.dev
      auth:
        secretRef:
          credentials:
            name: bitwarden-cli-prod
            key: BW_SESSION
```

### 2. RBAC
Restrict who can create/modify ExternalSecrets:

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: external-secret-admin
  namespace: media
rules:
- apiGroups: ["external-secrets.io"]
  resources: ["externalsecrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
```

### 3. Audit Trail
- Bitwarden logs all access
- OpenShift audit logs for ExternalSecret changes
- Monitor ESO operator logs

## Monitoring

### Check ESO Status
```bash
# Check ClusterSecretStore
oc get clustersecretstore bitwarden-store -o yaml

# Check ExternalSecret status
oc get externalsecret -A

# Check generated Secrets
oc get secret plex-token -n media -o yaml

# View ESO operator logs
oc logs -n external-secrets deployment/external-secrets-operator -f
```

### Prometheus Metrics
ESO exposes metrics for monitoring:
- `externalsecret_sync_calls_total`
- `externalsecret_sync_calls_error`
- `externalsecret_status_condition`

## Migration Plan

### Phase 1: Install ESO (Week 1)
- [ ] Install External Secrets Operator
- [ ] Create bootstrap BW_SESSION SealedSecret
- [ ] Create ClusterSecretStore
- [ ] Test with one non-critical app (e.g., Plex)

### Phase 2: Migrate Media Apps (Week 2)
- [ ] Create Bitwarden items for media stack
- [ ] Create ExternalSecrets for Plex, Sonarr, Radarr
- [ ] Verify secrets created successfully
- [ ] Test app functionality
- [ ] Remove old SealedSecrets

### Phase 3: Migrate Core Apps (Week 3)
- [ ] Migrate Nautobot secrets
- [ ] Migrate ArgoCD secrets
- [ ] Migrate any database credentials
- [ ] Update documentation

### Phase 4: Cleanup (Week 4)
- [ ] Remove SealedSecrets controller (keep for bootstrap only)
- [ ] Update GitOps workflows
- [ ] Document new secret management process
- [ ] Train team on new workflow

## Comparison Matrix

| Feature | SealedSecrets | ESO + Bitwarden |
|---------|---------------|-----------------|
| **Secrets in Git** | Encrypted | No (just references) |
| **Single Source of Truth** | Git | Bitwarden |
| **Rotation Process** | Manual re-seal | Update in Bitwarden |
| **Multi-Cluster** | Separate sealing per cluster | Same Bitwarden vault |
| **Audit Trail** | Git commits | Bitwarden logs |
| **Backup/Restore** | Git history | Bitwarden backup |
| **Access Control** | Git + RBAC | Bitwarden + RBAC |
| **Learning Curve** | Medium | Low |
| **Operational Overhead** | High (sealing) | Low (automated sync) |

## Conclusion

**ESO + Bitwarden completely replaces SealedSecrets for cluster workloads.**

**Benefits:**
- ✅ No secrets in git (not even encrypted)
- ✅ Single source of truth (Bitwarden)
- ✅ Automatic rotation
- ✅ Multi-cluster support
- ✅ Better audit trail
- ✅ Easier operational management

**Keep SealedSecrets only for:**
- ESO's bootstrap credentials (BW_SESSION)
- Break-glass cluster-admin access

**Next Steps:**
1. Review this architecture with your team
2. Install ESO in a test namespace
3. Migrate one app (e.g., Plex) as proof of concept
4. Plan full migration timeline

Would you like me to:
1. Create the actual manifests for ESO installation?
2. Build a migration script to move from SealedSecrets to ESO?
3. Create a Bitwarden CLI helper to bulk-create items?
