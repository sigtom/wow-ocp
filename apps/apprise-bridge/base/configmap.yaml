apiVersion: v1
kind: ConfigMap
metadata:
  name: apprise-bridge-script
data:
  bridge.py: |
    import json
    from http.server import BaseHTTPRequestHandler, HTTPServer
    import urllib.request
    import os

    APPRISE_URL = os.environ.get('APPRISE_URL', 'http://apprise-api.media-stack.svc.cluster.local/notify')
    SLACK_URL = 'slack://TNXE2SPQE/B0A4YAEMURY/btJI348Nhvz6BOkqz57JdrMo/#ocp-alerts'

    class AlertHandler(BaseHTTPRequestHandler):
        def do_POST(self):
            content_length = int(self.headers['Content-Length'])
            post_data = self.rfile.read(content_length)
            data = json.loads(post_data.decode('utf-8'))
            
            for alert in data.get('alerts', []):
                status = alert.get('status', 'unknown').upper()
                name = alert.get('labels', {}).get('alertname', 'Unknown Alert')
                summary = alert.get('annotations', {}).get('summary', 'No summary')
                
                payload = {
                    'urls': SLACK_URL,
                    'title': f"OCP Alert: {name}",
                    'body': f"[{status}] {name}\n{summary}"
                }
                
                req = urllib.request.Request(APPRISE_URL, data=json.dumps(payload).encode('utf-8'), headers={'Content-Type': 'application/json'})
                try:
                    with urllib.request.urlopen(req) as f:
                        pass
                except Exception as e:
                    print(f"Error sending to Apprise: {e}")
                    
            self.send_response(204)
            self.end_headers()

    if __name__ == '__main__':
        print("Starting bridge on port 8080...")
        HTTPServer(('0.0.0.0', 8080), AlertHandler).serve_forever()
